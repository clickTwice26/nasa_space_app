{% extends 'base.html' %}
{% block title %}Create Account Â· TerraPulse{% endblock %}
{% block subtitle %}Get Started{% endblock %}
{% block head_extra %}
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    .step-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .step-enter { opacity: 0; transform: translateX(20px); }
    .step-enter-active { opacity: 1; transform: translateX(0); }
    .progress-fill { transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    .role-card:active, .loc-card:active { transform: scale(0.97); }
    @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-in { animation: slideIn 0.4s ease-out; }
  </style>
{% endblock %}
{% block content %}
<div class="min-h-screen bg-gray-50 pb-24">
  <!-- Header -->
  <div class="bg-gradient-to-br from-green-600 to-green-700 text-white px-6 pt-8 pb-16">
    <div class="max-w-md mx-auto">
      <a href="/auth/login" class="inline-flex items-center text-sm text-green-100 hover:text-white mb-4">
        <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i> Back to login
      </a>
      <h1 class="text-2xl font-bold">Create Account</h1>
      <p class="text-sm text-green-100 mt-1">Join TerraPulse community</p>
    </div>
  </div>

  <!-- Progress Steps -->
  <div class="-mt-8 px-6 mb-6">
    <div class="max-w-md mx-auto bg-white rounded-2xl shadow-lg shadow-gray-900/10 p-4">
      <div class="flex items-center justify-between mb-2">
        <span class="text-xs font-semibold text-gray-700" id="step-label">Step 1 of 4</span>
        <span class="text-xs text-gray-500" id="step-title">Account Info</span>
      </div>
      <div class="flex gap-1.5">
        {% for i in [1,2,3,4] %}
        <div class="flex-1 h-1.5 rounded-full bg-gray-100 overflow-hidden">
          <div id="bar-{{i}}" class="progress-fill h-full w-0 bg-gradient-to-r from-green-500 to-green-600"></div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Alert -->
  <div class="px-6 mb-4">
    <div id="alert" class="hidden max-w-md mx-auto"></div>
  </div>

  <!-- Steps Container -->
  <div class="px-6">
    <div class="max-w-md mx-auto">

      <!-- Step 1: Account -->
      <form id="step-1" class="step-card bg-white rounded-2xl shadow-lg shadow-gray-900/10 p-6 animate-in">
        <h2 class="text-lg font-bold text-gray-900 mb-4">Account Information</h2>
        <div class="space-y-3.5">
          <div>
            <label class="block text-xs font-semibold text-gray-700 mb-1.5">Email Address</label>
            <input name="email" type="email" required autocomplete="email" 
                   class="block w-full rounded-xl border border-gray-200 bg-gray-50 px-4 py-3 text-sm placeholder-gray-400 focus:border-green-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-green-500/20" 
                   placeholder="you@example.com" />
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-700 mb-1.5">Username</label>
            <input name="username" required autocomplete="username" 
                   class="block w-full rounded-xl border border-gray-200 bg-gray-50 px-4 py-3 text-sm placeholder-gray-400 focus:border-green-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-green-500/20" 
                   placeholder="Choose a username" />
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-700 mb-1.5">Password</label>
            <input name="password" type="password" required minlength="8" autocomplete="new-password" 
                   class="block w-full rounded-xl border border-gray-200 bg-gray-50 px-4 py-3 text-sm placeholder-gray-400 focus:border-green-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-green-500/20" 
                   placeholder="Min. 8 characters" />
            <p class="mt-1.5 text-[10px] text-gray-500">Use 8+ characters with letters and numbers</p>
          </div>
        </div>
        <button type="submit" class="w-full mt-6 rounded-xl bg-green-600 py-3.5 text-sm font-semibold text-white shadow-lg shadow-green-600/30 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition">Continue</button>
      </form>

      <!-- Step 2: Role -->
      <div id="step-2" class="step-card hidden bg-white rounded-2xl shadow-lg shadow-gray-900/10 p-6">
        <h2 class="text-lg font-bold text-gray-900 mb-1">Select Your Role</h2>
        <p class="text-xs text-gray-500 mb-4">Choose what describes you best</p>
        <div class="space-y-3">
          <button data-role="student" class="role-card w-full flex items-center gap-3 p-4 border-2 border-gray-200 rounded-xl hover:border-green-500 hover:bg-green-50 transition">
            <div class="w-10 h-10 rounded-xl bg-blue-100 flex items-center justify-center flex-shrink-0">
              <i data-lucide="graduation-cap" class="w-5 h-5 text-blue-600"></i>
            </div>
            <div class="text-left">
              <div class="text-sm font-semibold text-gray-900">Student</div>
              <div class="text-xs text-gray-500">Learning about environment</div>
            </div>
          </button>
          <button data-role="farmer" class="role-card w-full flex items-center gap-3 p-4 border-2 border-gray-200 rounded-xl hover:border-green-500 hover:bg-green-50 transition">
            <div class="w-10 h-10 rounded-xl bg-green-100 flex items-center justify-center flex-shrink-0">
              <i data-lucide="sprout" class="w-5 h-5 text-green-600"></i>
            </div>
            <div class="text-left">
              <div class="text-sm font-semibold text-gray-900">Farmer</div>
              <div class="text-xs text-gray-500">Managing agricultural land</div>
            </div>
          </button>
          <button data-role="researcher" class="role-card w-full flex items-center gap-3 p-4 border-2 border-gray-200 rounded-xl hover:border-green-500 hover:bg-green-50 transition">
            <div class="w-10 h-10 rounded-xl bg-purple-100 flex items-center justify-center flex-shrink-0">
              <i data-lucide="microscope" class="w-5 h-5 text-purple-600"></i>
            </div>
            <div class="text-left">
              <div class="text-sm font-semibold text-gray-900">Researcher</div>
              <div class="text-xs text-gray-500">Studying environmental data</div>
            </div>
          </button>
        </div>
        <div class="flex gap-3 mt-6">
          <button id="back-2" class="flex-1 rounded-xl border-2 border-gray-200 bg-white py-3 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition">Back</button>
          <button id="next-2" disabled class="flex-1 rounded-xl bg-green-600 py-3 text-sm font-semibold text-white shadow-lg shadow-green-600/30 disabled:opacity-40 disabled:shadow-none transition">Next</button>
        </div>
      </div>

      <!-- Step 3: Location Type -->
      <div id="step-3" class="step-card hidden bg-white rounded-2xl shadow-lg shadow-gray-900/10 p-6">
        <h2 class="text-lg font-bold text-gray-900 mb-1">Location Type</h2>
        <p class="text-xs text-gray-500 mb-4">How do you track your location?</p>
        <div class="space-y-3">
          <button data-type="fixed" class="loc-card w-full flex items-center gap-3 p-4 border-2 border-gray-200 rounded-xl hover:border-green-500 hover:bg-green-50 transition">
            <div class="w-10 h-10 rounded-xl bg-orange-100 flex items-center justify-center flex-shrink-0">
              <i data-lucide="map-pin" class="w-5 h-5 text-orange-600"></i>
            </div>
            <div class="text-left">
              <div class="text-sm font-semibold text-gray-900">Fixed Point</div>
              <div class="text-xs text-gray-500">Single location (home/farm)</div>
            </div>
          </button>
          <button data-type="journey" class="loc-card w-full flex items-center gap-3 p-4 border-2 border-gray-200 rounded-xl hover:border-green-500 hover:bg-green-50 transition">
            <div class="w-10 h-10 rounded-xl bg-teal-100 flex items-center justify-center flex-shrink-0">
              <i data-lucide="route" class="w-5 h-5 text-teal-600"></i>
            </div>
            <div class="text-left">
              <div class="text-sm font-semibold text-gray-900">Journey</div>
              <div class="text-xs text-gray-500">Start and end points</div>
            </div>
          </button>
        </div>
        <div class="flex gap-3 mt-6">
          <button id="back-3" class="flex-1 rounded-xl border-2 border-gray-200 bg-white py-3 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition">Back</button>
          <button id="next-3" disabled class="flex-1 rounded-xl bg-green-600 py-3 text-sm font-semibold text-white shadow-lg shadow-green-600/30 disabled:opacity-40 disabled:shadow-none transition">Next</button>
        </div>
      </div>

      <!-- Step 4: Map -->
      <div id="step-4" class="step-card hidden bg-white rounded-2xl shadow-lg shadow-gray-900/10 p-6">
        <h2 class="text-lg font-bold text-gray-900 mb-1" id="map-title">Set Location</h2>
        <p id="map-hint" class="text-xs text-gray-500 mb-4">Tap on the map to mark your point</p>
        <div id="journey-hint" class="hidden text-xs text-gray-500 mb-4">Tap to set start, then end point</div>
        <div id="map" class="h-56 w-full rounded-xl border-2 border-gray-200 overflow-hidden mb-3"></div>
        <div id="coord-display" class="text-[10px] font-mono text-gray-600 bg-gray-50 rounded-lg p-2 min-h-[2rem]"></div>
        <div class="flex gap-3 mt-6">
          <button id="back-4" class="flex-1 rounded-xl border-2 border-gray-200 bg-white py-3 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition">Back</button>
          <button id="finish" disabled class="flex-1 rounded-xl bg-green-600 py-3 text-sm font-semibold text-white shadow-lg shadow-green-600/30 disabled:opacity-40 disabled:shadow-none transition">Finish</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  const stepTitles=['Account Info','Select Role','Location Type','Set Location'];
  const steps=[1,2,3,4];let currentStep=1;let selectedRole=null;let locationType=null;let map,marker,startMarker,endMarker,journeyPhase=0;let coords={};
  function setAlert(msg,type='info'){const box=document.getElementById('alert');box.innerHTML=`<div class="flex items-start gap-2 p-3 rounded-xl ${type==='error'?'bg-red-50':'bg-green-50'}"><i data-lucide="${type==='error'?'alert-circle':'check-circle'}" class="w-4 h-4 ${type==='error'?'text-red-600':'text-green-600'} mt-0.5 flex-shrink-0"></i><span class="text-xs ${type==='error'?'text-red-800':'text-green-800'} leading-relaxed">${msg}</span></div>`;box.classList.remove('hidden');lucide.createIcons();}
  function clearAlert(){document.getElementById('alert').classList.add('hidden');}
  function go(step){steps.forEach(s=>document.getElementById('step-'+s).classList.add('hidden'));const el=document.getElementById('step-'+step);el.classList.remove('hidden');el.classList.add('step-enter');requestAnimationFrame(()=>{el.classList.add('step-enter-active');setTimeout(()=>{el.classList.remove('step-enter','step-enter-active')},300)});currentStep=step;updateBars();document.getElementById('step-label').textContent=`Step ${step} of 4`;document.getElementById('step-title').textContent=stepTitles[step-1];}
  function updateBars(){steps.forEach((s,i)=>{document.getElementById('bar-'+s).style.width=(currentStep>i?'100%':'0')});}
  document.getElementById('step-1').addEventListener('submit',async e=>{e.preventDefault();clearAlert();const fd=new FormData(e.target);const payload={email:fd.get('email'),username:fd.get('username'),password:fd.get('password')};try{const r=await fetch('/auth/api/register/start',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(payload)});const data=await r.json();if(!data.success)return setAlert(data.message,'error');go(2);}catch(err){setAlert('Network error. Try again.','error');}});
  document.querySelectorAll('.role-card').forEach(btn=>btn.addEventListener('click',e=>{e.preventDefault();selectedRole=btn.dataset.role;document.querySelectorAll('.role-card').forEach(b=>b.classList.remove('border-green-500','bg-green-50','ring-2','ring-green-500'));btn.classList.add('border-green-500','bg-green-50','ring-2','ring-green-500');document.getElementById('next-2').disabled=false;}));
  document.getElementById('back-2').onclick=()=>go(1);
  document.getElementById('next-2').onclick=async()=>{clearAlert();try{const r=await fetch('/auth/api/register/role',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({role:selectedRole})});const data=await r.json();if(!data.success)return setAlert(data.message,'error');go(3);}catch(e){setAlert('Error saving role','error')}};
  document.querySelectorAll('.loc-card').forEach(btn=>btn.addEventListener('click',e=>{e.preventDefault();locationType=btn.dataset.type;document.querySelectorAll('.loc-card').forEach(b=>b.classList.remove('border-green-500','bg-green-50','ring-2','ring-green-500'));btn.classList.add('border-green-500','bg-green-50','ring-2','ring-green-500');document.getElementById('next-3').disabled=false;}));
  document.getElementById('back-3').onclick=()=>go(2);
  document.getElementById('next-3').onclick=()=>{go(4);setTimeout(initMap,100);};
  function initMap(){if(map)return;map=L.map('map').setView([23.8103,90.4125],7);L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OSM'}).addTo(map);map.on('click',onMapClick);} 
  function onMapClick(e){if(locationType==='fixed'){if(!marker){marker=L.marker(e.latlng,{draggable:true}).addTo(map).on('dragend',updateFixed);}marker.setLatLng(e.latlng);coords.latitude=e.latlng.lat;coords.longitude=e.latlng.lng;updateFixed();}else{if(journeyPhase===0){if(startMarker)map.removeLayer(startMarker);if(endMarker){map.removeLayer(endMarker);endMarker=null;}startMarker=L.marker(e.latlng,{draggable:true}).addTo(map).on('dragend',updateJourney);coords.start_latitude=e.latlng.lat;coords.start_longitude=e.latlng.lng;journeyPhase=1;document.getElementById('journey-hint').textContent='Now tap to set end point';document.getElementById('journey-hint').classList.remove('hidden');document.getElementById('map-hint').classList.add('hidden');}else{if(endMarker)map.removeLayer(endMarker);endMarker=L.marker(e.latlng,{draggable:true}).addTo(map).on('dragend',updateJourney);coords.end_latitude=e.latlng.lat;coords.end_longitude=e.latlng.lng;journeyPhase=0;}updateJourney();}}
  function updateFixed(){const ll=marker.getLatLng();coords.latitude=ll.lat;coords.longitude=ll.lng;document.getElementById('coord-display').innerHTML=`<div class="text-center">Lat: ${ll.lat.toFixed(5)}, Lng: ${ll.lng.toFixed(5)}</div>`;document.getElementById('finish').disabled=false;}
  function updateJourney(){let html='';if(startMarker){const ll=startMarker.getLatLng();coords.start_latitude=ll.lat;coords.start_longitude=ll.lng;html+=`Start: ${ll.lat.toFixed(5)}, ${ll.lng.toFixed(5)}<br>`;}if(endMarker){const ll2=endMarker.getLatLng();coords.end_latitude=ll2.lat;coords.end_longitude=ll2.lng;html+=`End: ${ll2.lat.toFixed(5)}, ${ll2.lng.toFixed(5)}`;document.getElementById('finish').disabled=false;}document.getElementById('coord-display').innerHTML=html||'<div class="text-center text-gray-400">Tap map to mark points</div>';}
  document.getElementById('back-4').onclick=()=>go(3);
  document.getElementById('finish').onclick=async()=>{clearAlert();const btn=document.getElementById('finish');btn.disabled=true;btn.textContent='Finishing...';const payload={location_type:locationType,...coords};try{const r=await fetch('/auth/api/register/location',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(payload)});const data=await r.json();if(!data.success){btn.disabled=false;btn.textContent='Finish';return setAlert(data.message,'error');}const c=await fetch('/auth/api/register/complete',{method:'POST',credentials:'include'});const cd=await c.json();if(!cd.success){btn.disabled=false;btn.textContent='Finish';return setAlert(cd.message,'error');}setAlert('Success! Redirecting...','info');setTimeout(()=>{window.location.href='/dashboard';},600);}catch(e){btn.disabled=false;btn.textContent='Finish';setAlert('Error completing registration','error');}};
</script>
{% endblock %}
