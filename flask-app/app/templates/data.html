{% extends "base.html" %}

{% block title %}TerraPulse - Data Insights{% endblock %}
{% block subtitle %}NASA Data Analytics{% endblock %}

{% block content %}
<div class="space-y-4 pb-32">
    <!-- Header Card -->
    <div class="card bg-gradient-to-br from-blue-500 to-blue-600 text-white border-blue-300">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-lg font-semibold mb-1">NASA Data Insights</h2>
                <p class="text-sm opacity-90">Real-time satellite and weather data</p>
            </div>
            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                <i data-lucide="satellite" class="w-6 h-6"></i>
            </div>
        </div>
    </div>

    <!-- Data Sources -->
    <div class="grid grid-cols-2 gap-3">
        <div class="card card-compact bg-blue-50 border-blue-200">
            <div class="text-center">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mx-auto mb-2">
                    <i data-lucide="cloud" class="w-5 h-5 text-blue-600"></i>
                </div>
                <div class="font-medium text-sm text-blue-900">Weather Data</div>
                <div class="text-xs text-blue-600">NASA POWER</div>
            </div>
        </div>
        
        <div class="card card-compact bg-green-50 border-green-200">
            <div class="text-center">
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mx-auto mb-2">
                    <i data-lucide="droplets" class="w-5 h-5 text-green-600"></i>
                </div>
                <div class="font-medium text-sm text-green-900">Precipitation</div>
                <div class="text-xs text-green-600">GPM IMERG</div>
            </div>
        </div>
        
        <div class="card card-compact bg-purple-50 border-purple-200">
            <div class="text-center">
                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mx-auto mb-2">
                    <i data-lucide="wind" class="w-5 h-5 text-purple-600"></i>
                </div>
                <div class="font-medium text-sm text-purple-900">Air Quality</div>
                <div class="text-xs text-purple-600">MODIS</div>
            </div>
        </div>
        
        <div class="card card-compact bg-orange-50 border-orange-200">
            <div class="text-center">
                <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center mx-auto mb-2">
                    <i data-lucide="globe" class="w-5 h-5 text-orange-600"></i>
                </div>
                <div class="font-medium text-sm text-orange-900">Imagery</div>
                <div class="text-xs text-orange-600">Worldview</div>
            </div>
        </div>
    </div>

    <!-- Current Conditions -->
    <div class="card">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-900">Current Conditions</h3>
            <button onclick="refreshData()" class="btn btn-sm btn-secondary" id="refreshBtn">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
            </button>
        </div>
        
        <div id="currentConditions" class="space-y-3">
            <!-- Loading state -->
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                <div class="text-center">
                    <div class="w-8 h-8 bg-gray-300 rounded-full animate-pulse mx-auto mb-3"></div>
                    <p class="text-sm text-gray-600">Loading current conditions...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- NASA Weather Parameters -->
    <div class="card">
        <h3 class="font-semibold text-gray-900 mb-4">NASA POWER Weather Data</h3>
        
        <div class="grid grid-cols-1 gap-3" id="weatherParams">
            <!-- Temperature -->
            <div class="bg-gradient-to-r from-red-50 to-orange-50 rounded-lg p-4 border border-red-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
                            <i data-lucide="thermometer" class="w-5 h-5 text-red-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">Temperature</div>
                            <div class="text-sm text-gray-600">2m above surface</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-red-700" id="temperature">--°C</div>
                        <div class="text-xs text-red-600">Current</div>
                    </div>
                </div>
            </div>

            <!-- Humidity -->
            <div class="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg p-4 border border-blue-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i data-lucide="droplets" class="w-5 h-5 text-blue-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">Relative Humidity</div>
                            <div class="text-sm text-gray-600">2m above surface</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-blue-700" id="humidity">--%</div>
                        <div class="text-xs text-blue-600">Current</div>
                    </div>
                </div>
            </div>

            <!-- Wind Speed -->
            <div class="bg-gradient-to-r from-green-50 to-teal-50 rounded-lg p-4 border border-green-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                            <i data-lucide="wind" class="w-5 h-5 text-green-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">Wind Speed</div>
                            <div class="text-sm text-gray-600">10m above surface</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-green-700" id="windSpeed">-- km/h</div>
                        <div class="text-xs text-green-600">Current</div>
                    </div>
                </div>
            </div>

            <!-- Precipitation -->
            <div class="bg-gradient-to-r from-purple-50 to-violet-50 rounded-lg p-4 border border-purple-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i data-lucide="cloud-rain" class="w-5 h-5 text-purple-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">Precipitation</div>
                            <div class="text-sm text-gray-600">Last 24 hours</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-purple-700" id="precipitation">-- mm</div>
                        <div class="text-xs text-purple-600">24h total</div>
                    </div>
                </div>
            </div>
        </div>

        <button onclick="loadWeatherData()" class="btn btn-outline w-full mt-4">
            <i data-lucide="download" class="w-4 h-4"></i>
            <span>Load NASA Weather Data</span>
        </button>
    </div>

    <!-- Satellite Imagery -->
    <div class="card">
        <h3 class="font-semibold text-gray-900 mb-4">NASA Worldview Imagery</h3>
        
        <div class="space-y-3">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="loadImagery('true_color')" class="btn btn-outline btn-sm">
                    <i data-lucide="image" class="w-4 h-4"></i>
                    <span>True Color</span>
                </button>
                <button onclick="loadImagery('vegetation')" class="btn btn-outline btn-sm">
                    <i data-lucide="leaf" class="w-4 h-4"></i>
                    <span>Vegetation</span>
                </button>
                <button onclick="loadImagery('temperature')" class="btn btn-outline btn-sm">
                    <i data-lucide="thermometer" class="w-4 h-4"></i>
                    <span>Temperature</span>
                </button>
                <button onclick="loadImagery('moisture')" class="btn btn-outline btn-sm">
                    <i data-lucide="droplets" class="w-4 h-4"></i>
                    <span>Soil Moisture</span>
                </button>
            </div>
            
            <div id="imageryContainer" class="bg-gray-50 rounded-lg p-4 border border-gray-200 min-h-32">
                <div class="text-center">
                    <i data-lucide="satellite" class="w-12 h-12 text-gray-400 mx-auto mb-3"></i>
                    <p class="text-sm text-gray-600">Select an imagery type to view satellite data</p>
                    <p class="text-xs text-gray-500 mt-1">Powered by NASA Worldview</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Air Quality Data -->
    <div class="card">
        <h3 class="font-semibold text-gray-900 mb-4">Air Quality (MODIS)</h3>
        
        <div class="space-y-3" id="airQualityData">
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                <div class="text-center">
                    <i data-lucide="wind" class="w-8 h-8 text-gray-400 mx-auto mb-3"></i>
                    <p class="text-sm text-gray-600">Loading air quality data...</p>
                </div>
            </div>
        </div>
        
        <button onclick="loadAirQuality()" class="btn btn-outline w-full mt-3">
            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
            <span>Load Air Quality Data</span>
        </button>
    </div>

    <!-- Historical Data -->
    <div class="card">
        <h3 class="font-semibold text-gray-900 mb-4">Historical Trends</h3>
        
        <div class="grid grid-cols-1 gap-3">
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-medium text-gray-900">7-Day Temperature Avg</div>
                        <div class="text-sm text-gray-600">Last week average</div>
                    </div>
                    <div class="text-lg font-bold text-blue-700" id="tempAvg">--°C</div>
                </div>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-medium text-gray-900">Weekly Precipitation</div>
                        <div class="text-sm text-gray-600">Last 7 days total</div>
                    </div>
                    <div class="text-lg font-bold text-green-700" id="precipWeek">-- mm</div>
                </div>
            </div>
        </div>
        
        <button onclick="loadHistoricalData()" class="btn btn-outline w-full mt-3">
            <i data-lucide="calendar" class="w-4 h-4"></i>
            <span>Load Historical Data</span>
        </button>
    </div>

    <!-- Data Export -->
    <div class="card">
        <h3 class="font-semibold text-gray-900 mb-4">Export Data</h3>
        <p class="text-sm text-gray-600 mb-4">Download NASA data for further analysis</p>
        
        <div class="grid grid-cols-2 gap-3">
            <button onclick="exportData('csv')" class="btn btn-outline">
                <i data-lucide="file-text" class="w-4 h-4"></i>
                <span>CSV Export</span>
            </button>
            <button onclick="exportData('json')" class="btn btn-outline">
                <i data-lucide="code" class="w-4 h-4"></i>
                <span>JSON Export</span>
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();
    loadInitialData();
});

async function loadInitialData() {
    // Load current conditions on page load
    refreshData();
}

async function refreshData() {
    const refreshBtn = document.getElementById('refreshBtn');
    const conditionsDiv = document.getElementById('currentConditions');
    
    // Show loading state
    refreshBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>';
    
    try {
        const response = await fetch('/api/current-conditions');
        if (!response.ok) throw new Error('Failed to fetch data');
        
        const data = await response.json();
        displayCurrentConditions(data);
        
    } catch (error) {
        console.error('Error loading data:', error);
        conditionsDiv.innerHTML = `
            <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                <div class="text-center">
                    <i data-lucide="alert-circle" class="w-8 h-8 text-red-400 mx-auto mb-3"></i>
                    <p class="text-sm text-red-600">Failed to load current conditions</p>
                </div>
            </div>
        `;
    } finally {
        refreshBtn.innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4"></i>';
        lucide.createIcons();
    }
}

function displayCurrentConditions(data) {
    const container = document.getElementById('currentConditions');
    
    // Parse the actual API response structure
    const current = data.current || {};
    
    container.innerHTML = `
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-blue-50 rounded-lg p-3 border border-blue-200 text-center">
                <div class="text-lg font-bold text-blue-700">${current.temperature || '--'}°C</div>
                <div class="text-xs text-blue-600">Temperature</div>
            </div>
            <div class="bg-green-50 rounded-lg p-3 border border-green-200 text-center">
                <div class="text-lg font-bold text-green-700">${current.humidity || '--'}%</div>
                <div class="text-xs text-green-600">Humidity</div>
            </div>
            <div class="bg-purple-50 rounded-lg p-3 border border-purple-200 text-center">
                <div class="text-lg font-bold text-purple-700">${current.wind_speed || '--'} km/h</div>
                <div class="text-xs text-purple-600">Wind Speed</div>
            </div>
            <div class="bg-orange-50 rounded-lg p-3 border border-orange-200 text-center">
                <div class="text-lg font-bold text-orange-700">${current.precipitation || '--'} mm</div>
                <div class="text-xs text-orange-600">Rainfall</div>
            </div>
        </div>
        <div class="mt-3 bg-gray-50 rounded-lg p-3 border border-gray-200">
            <div class="flex items-center justify-between text-sm">
                <span class="text-gray-600">Weather:</span>
                <span class="font-medium text-gray-900">${current.weather_description || 'N/A'}</span>
            </div>
            <div class="flex items-center justify-between text-sm mt-1">
                <span class="text-gray-600">UV Index:</span>
                <span class="font-medium text-gray-900">${current.uv_index || '--'}</span>
            </div>
        </div>
        <p class="text-xs text-gray-500 text-center mt-3">Last updated: ${new Date().toLocaleString()}</p>
    `;
}

async function loadWeatherData() {
    try {
        const response = await fetch('/api/nasa-weather');
        if (!response.ok) throw new Error('Failed to fetch weather data');
        
        const data = await response.json();
        
        // Update individual parameter displays - parse nested structure
        const params = data.parameters || {};
        document.getElementById('temperature').textContent = `${params.temperature_2m?.value || '--'}°C`;
        document.getElementById('humidity').textContent = `${params.humidity?.value || '--'}%`;
        document.getElementById('windSpeed').textContent = `${params.wind_speed?.value ? (params.wind_speed.value * 3.6).toFixed(1) : '--'} km/h`;
        document.getElementById('precipitation').textContent = `${params.precipitation?.value || '--'} mm`;
        
    } catch (error) {
        console.error('Weather data error:', error);
        alert('Failed to load NASA weather data');
    }
}

async function loadImagery(type) {
    const container = document.getElementById('imageryContainer');
    
    container.innerHTML = `
        <div class="text-center py-4">
            <div class="w-8 h-8 bg-blue-300 rounded-full animate-pulse mx-auto mb-3"></div>
            <p class="text-sm text-gray-600">Loading ${type.replace('_', ' ')} imagery...</p>
            <p class="text-xs text-gray-500">Connecting to NASA Worldview</p>
        </div>
    `;
    
    try {
        const response = await fetch(`/api/imagery/${type}`);
        if (!response.ok) throw new Error('Failed to load imagery');
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Failed to retrieve imagery');
        }
        
        container.innerHTML = `
            <div class="text-center">
                <div class="relative">
                    <img id="imagery-${type}" 
                         src="${data.image_url}" 
                         alt="${type} imagery" 
                         class="w-full rounded-lg border border-gray-300 mb-3"
                         onload="handleImageLoad(this)"
                         onerror="handleImageError(this, '${type}')"
                         style="opacity: 0; transition: opacity 0.3s; max-height: 300px; object-fit: cover;">
                    <div class="absolute top-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded">
                        ${data.resolution}
                    </div>
                </div>
                <div class="text-left space-y-1">
                    <p class="text-sm font-medium text-gray-900">${data.description}</p>
                    <p class="text-xs text-gray-600">Layer: ${data.layer_name}</p>
                    <p class="text-xs text-gray-500">Date: ${data.date} • Source: ${data.source}</p>
                </div>
                <button onclick="refreshImagery('${type}')" class="btn btn-sm btn-outline mt-3 w-full">
                    <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                    Refresh Image
                </button>
            </div>
        `;
        
        // Add timeout for image loading
        setTimeout(() => {
            const img = document.getElementById(`imagery-${type}`);
            if (img && img.style.opacity === '0') {
                handleImageError(img, type);
            }
        }, 10000); // 10 second timeout
        
        // Recreate icons
        lucide.createIcons();
        
    } catch (error) {
        console.error('Imagery error:', error);
        container.innerHTML = `
            <div class="text-center py-6">
                <i data-lucide="satellite-dish" class="w-12 h-12 text-orange-400 mx-auto mb-3"></i>
                <p class="text-sm text-gray-700 font-medium mb-2">NASA Worldview Imagery</p>
                <p class="text-xs text-gray-600 mb-3">Live satellite imagery from NASA's Earth Observing System</p>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                    <p class="text-xs text-yellow-800">Note: Live imagery requires NASA Earthdata login</p>
                </div>
                <button onclick="loadImagery('${type}')" class="btn btn-sm btn-outline">
                    <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                    Try Again
                </button>
            </div>
        `;
        lucide.createIcons();
    }
}

function handleImageError(img, type) {
    console.log('Image failed to load, showing placeholder');
    
    // Show fallback placeholder
    img.parentNode.innerHTML = `
        <div class="bg-gradient-to-br from-blue-100 to-green-100 rounded-lg border border-gray-300 p-8 mb-3">
            <div class="text-center">
                <i data-lucide="satellite" class="w-16 h-16 text-blue-500 mx-auto mb-4"></i>
                <p class="text-sm font-medium text-gray-700">NASA ${type.replace('_', ' ').toUpperCase()} Imagery</p>
                <p class="text-xs text-gray-500 mt-1">Satellite data visualization</p>
                <p class="text-xs text-red-500 mt-2">Image temporarily unavailable</p>
                <button onclick="refreshImagery('${type}')" class="btn btn-sm btn-primary mt-3">
                    <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                    Retry
                </button>
            </div>
        </div>
    `;
    lucide.createIcons();
}

function refreshImagery(type) {
    loadImagery(type);
}

async function loadAirQuality() {
    const container = document.getElementById('airQualityData');
    
    container.innerHTML = `
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
            <div class="text-center">
                <div class="w-8 h-8 bg-gray-300 rounded-full animate-pulse mx-auto mb-3"></div>
                <p class="text-sm text-gray-600">Loading air quality data...</p>
            </div>
        </div>
    `;
    
    try {
        const response = await fetch('/api/air-quality');
        if (!response.ok) throw new Error('Failed to load air quality');
        
        const data = await response.json();
        
        container.innerHTML = `
            <div class="space-y-3">
                <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-gray-900">PM2.5</span>
                        <span class="text-lg font-bold text-blue-700">${data.pm25 || '--'} μg/m³</span>
                    </div>
                </div>
                <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-gray-900">PM10</span>
                        <span class="text-lg font-bold text-green-700">${data.pm10 || '--'} μg/m³</span>
                    </div>
                </div>
                <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-gray-900">AOD</span>
                        <span class="text-lg font-bold text-purple-700">${data.aod || '--'}</span>
                    </div>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('Air quality error:', error);
        container.innerHTML = `
            <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                <div class="text-center">
                    <i data-lucide="alert-circle" class="w-8 h-8 text-red-400 mx-auto mb-3"></i>
                    <p class="text-sm text-red-600">Failed to load air quality data</p>
                </div>
            </div>
        `;
        lucide.createIcons();
    }
}

async function loadHistoricalData() {
    try {
        const response = await fetch('/api/historical-data');
        if (!response.ok) throw new Error('Failed to load historical data');
        
        const data = await response.json();
        
        document.getElementById('tempAvg').textContent = `${data.temp_avg || '--'}°C`;
        document.getElementById('precipWeek').textContent = `${data.precip_week || '--'} mm`;
        
    } catch (error) {
        console.error('Historical data error:', error);
        alert('Failed to load historical data');
    }
}

async function exportData(format) {
    try {
        const response = await fetch(`/api/export-data?format=${format}`);
        if (!response.ok) throw new Error('Export failed');
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `nasa_data_${new Date().toISOString().split('T')[0]}.${format}`;
        a.click();
        window.URL.revokeObjectURL(url);
        
    } catch (error) {
        console.error('Export error:', error);
        alert('Failed to export data');
    }
}

// Image handling functions
function handleImageLoad(img) {
    img.style.opacity = '1';
    console.log('Image loaded successfully:', img.src);
}

async function refreshImagery(type) {
    const container = document.getElementById(`${type}ImageryContainer`);
    if (container) {
        await loadImagery(type);
    }
}
</script>
{% endblock %}