{% extends "base.html" %}

{% block title %}Risk Dashboard - TerraPulse{% endblock %}
{% block subtitle %}NASA-Powered Crop Risk Analysis{% endblock %}

{% block head_extra %}
<style>
    /* Mobile-optimized risk dashboard styles */
    .risk-card {
        background: var(--bg-primary);
        border-radius: var(--border-radius-md);
        border: 1px solid var(--border-light);
        box-shadow: var(--shadow-sm);
        margin-bottom: var(--spacing-lg);
        transition: all 0.2s ease;
    }
    
    .risk-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
    }
    
    .risk-low { 
        background: #d4edda; 
        color: #155724; 
        border-color: #c3e6cb;
        border-radius: var(--border-radius-sm);
        padding: var(--spacing-sm) var(--spacing-md);
    }
    .risk-medium { 
        background: #fff3cd; 
        color: #856404; 
        border-color: #ffeaa7;
        border-radius: var(--border-radius-sm);
        padding: var(--spacing-sm) var(--spacing-md);
    }
    .risk-high { 
        background: #f8d7da; 
        color: #721c24; 
        border-color: #f5c6cb;
        border-radius: var(--border-radius-sm);
        padding: var(--spacing-sm) var(--spacing-md);
    }
    .alert-item { 
        background: #fff8e1; 
        padding: var(--spacing-md); 
        border-radius: var(--border-radius-sm); 
        margin-bottom: var(--spacing-sm); 
        border-left: 3px solid #ffc107;
        font-size: 0.875rem;
        line-height: 1.5;
        border: 1px solid #ffeaa7;
    }
    .recommendation-item { 
        background: #e3f2fd; 
        padding: var(--spacing-md); 
        border-radius: var(--border-radius-sm); 
        margin-bottom: var(--spacing-sm); 
        border-left: 3px solid #2196f3;
        font-size: 0.875rem;
        line-height: 1.5;
        border: 1px solid #bbdefb;
    }
    
    .mobile-form-card {
        background: var(--bg-primary);
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-light);
        margin-bottom: var(--spacing-lg);
    }
    
    .mobile-input {
        width: 100%;
        padding: var(--spacing-md);
        border: 1px solid var(--border-medium);
        border-radius: var(--border-radius-sm);
        font-size: 1rem;
        background: var(--bg-primary);
        transition: border-color 0.2s ease;
    }
    
    .mobile-input:focus {
        outline: none;
        border-color: #059669;
        box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
    }
    
    .mobile-btn {
        width: 100%;
        padding: var(--spacing-md);
        background: #059669;
        color: white;
        border: none;
        border-radius: var(--border-radius-sm);
        font-weight: 600;
        font-size: 1rem;
        touch-action: manipulation;
        transition: all 0.2s ease;
    }
    
    .mobile-btn:hover {
        background: #047857;
        transform: translateY(-1px);
    }
    
    .mobile-btn:active {
        transform: scale(0.98);
    }
    
    .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #48c085;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .risk-badge {
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--border-radius-xl);
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 2px solid;
        display: inline-block;
    }
    
    .section-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-sm);
        border-bottom: 2px solid var(--border-light);
    }
    
    .icon-badge {
        width: 32px;
        height: 32px;
        border-radius: var(--border-radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }
    
    /* Mobile-specific adjustments */
    @media (max-width: 768px) {
        .mobile-grid {
            grid-template-columns: 1fr;
            gap: var(--spacing-lg);
        }
        
        .mobile-two-col {
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-4 pb-32">
    <!-- Risk Analysis Form -->
    <div class="mobile-form-card">
        <div class="app-card-header">
            <div class="section-header">
                <div class="icon-badge bg-terra-green-500 text-white">
                    <i data-lucide="search" class="w-4 h-4"></i>
                </div>
                <div>
                    <h2 class="text-heading-2 text-gray-900">Crop Risk Analysis</h2>
                    <p class="text-caption text-gray-600">Analyze crop risks using NASA satellite data</p>
                </div>
            </div>
        </div>
        
        <div class="app-card-body">
            <form id="riskAnalysisForm">
                <div class="grid mobile-grid gap-4 mb-6">
                    <div class="space-y-2">
                        <label for="latitude" class="block text-body font-medium text-gray-700">
                            <i data-lucide="map-pin" class="w-4 h-4 inline mr-1"></i>
                            Latitude
                        </label>
                        <input type="number" 
                               id="latitude" 
                               step="0.0001" 
                               placeholder="23.7644" 
                               value="23.7644"
                               class="mobile-input"
                               required>
                    </div>
                    
                    <div class="space-y-2">
                        <label for="longitude" class="block text-body font-medium text-gray-700">
                            <i data-lucide="map-pin" class="w-4 h-4 inline mr-1"></i>
                            Longitude
                        </label>
                        <input type="number" 
                               id="longitude" 
                               step="0.0001" 
                               placeholder="90.3948" 
                               value="90.3948"
                               class="mobile-input"
                               required>
                    </div>
                    
                    <div class="space-y-2">
                        <label for="cropType" class="block text-body font-medium text-gray-700">
                            <i data-lucide="wheat" class="w-4 h-4 inline mr-1"></i>
                            Crop Type
                        </label>
                        <select id="cropType" class="mobile-input" required>
                            <option value="">Select Crop</option>
                            <option value="rice">Rice</option>
                            <option value="wheat">Wheat</option>
                            <option value="jute">Jute</option>
                            <option value="sugarcane">Sugarcane</option>
                            <option value="tea">Tea</option>
                            <option value="cotton">Cotton</option>
                        </select>
                    </div>
                    
                    <div class="space-y-2">
                        <label for="season" class="block text-body font-medium text-gray-700">
                            <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>
                            Season
                        </label>
                        <select id="season" class="mobile-input" required>
                            <option value="">Select Season</option>
                            <option value="kharif">Kharif (Summer)</option>
                            <option value="rabi">Rabi (Winter)</option>
                            <option value="boro">Boro (Spring)</option>
                        </select>
                    </div>
                    
                    <div class="space-y-2">
                        <label for="analysisDate" class="block text-body font-medium text-gray-700">
                            <i data-lucide="calendar-days" class="w-4 h-4 inline mr-1"></i>
                            Analysis Date
                        </label>
                        <input type="date" 
                               id="analysisDate" 
                               class="mobile-input"
                               required>
                    </div>
                </div>
                
                <!-- Quick Location Examples -->
                <div class="mb-6">
                    <p class="text-body font-medium text-gray-700 mb-3">Quick Examples:</p>
                    <div class="grid mobile-two-col gap-2">
                        <button type="button" class="example-btn btn-mobile text-left" onclick="fillLocation(23.7644, 90.3948, 'Dhaka')">
                            üìç Dhaka
                        </button>
                        <button type="button" class="example-btn btn-mobile text-left" onclick="fillLocation(24.8949, 91.8687, 'Sylhet')">
                            üìç Sylhet
                        </button>
                        <button type="button" class="example-btn btn-mobile text-left" onclick="fillLocation(22.3569, 91.7832, 'Chittagong')">
                            üìç Chittagong
                        </button>
                        <button type="button" class="example-btn btn-mobile text-left" onclick="fillLocation(24.3636, 88.6241, 'Rajshahi')">
                            üìç Rajshahi
                        </button>
                    </div>
                </div>
                
                <button type="submit" class="mobile-btn" id="analyzeBtn">
                    <i data-lucide="play-circle" class="w-4 h-4 inline mr-2"></i>
                    Analyze Risk
                </button>
            </form>
        </div>
    </div>
                    <label for="longitude" class="block text-sm font-medium text-gray-700">
                        <i data-lucide="map-pin" class="w-4 h-4 inline mr-1"></i>
                        Longitude
                    </label>
                    <input type="number" 
                           id="longitude" 
                           step="0.0001" 
                           placeholder="90.3897" 
                           value="90.3897"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-terra-green focus:border-terra-green transition-colors"
                           required>
                </div>
                
                <div class="space-y-2">
                    <label for="crop" class="block text-sm font-medium text-gray-700">
                        <i data-lucide="wheat" class="w-4 h-4 inline mr-1"></i>
                        Crop Type
                    </label>
                    <select id="crop" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-terra-green focus:border-terra-green transition-colors"
                            required>
                        <option value="">Select Crop</option>
                        <option value="rice" selected>üåæ Rice</option>
                        <option value="wheat">üåæ Wheat</option>
                        <option value="potato">ü•î Potato</option>
                        <option value="jute">üåø Jute</option>
                        <option value="corn">üåΩ Corn</option>
                    </select>
                </div>
                
                <div class="space-y-2">
                    <label for="startDate" class="block text-sm font-medium text-gray-700">
                        <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>
                        Start Date
                    </label>
                    <input type="date" 
                           id="startDate" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-terra-green focus:border-terra-green transition-colors"
                           required>
                </div>
                
                <div class="space-y-2">
                    <label for="endDate" class="block text-sm font-medium text-gray-700">
                        <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>
                        End Date
                    </label>
                    <input type="date" 
                           id="endDate" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-terra-green focus:border-terra-green transition-colors"
                           required>
                </div>
            </div>
            
            <button type="submit" 
                    id="analyzeBtn" 
                    class="w-full bg-terra-green text-white px-6 py-3 rounded-lg hover:bg-terra-green-600 transition-colors font-medium flex items-center justify-center gap-2">
                <i data-lucide="search" class="w-4 h-4"></i>
                Analyze Crop Risk
            </button>
        </form>
    </div>
    
    <!-- Loading State -->
    <!-- Loading State -->
    <div id="analysisLoading" class="hidden analysis-card p-8 text-center">
        <div class="loading-spinner mb-4"></div>
        <div class="section-header justify-center">
            <div class="icon-badge bg-terra-blue text-white">
                <i data-lucide="satellite" class="w-5 h-5"></i>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-900">Analyzing Crop Risks</h3>
                <p class="text-gray-600">Processing NASA satellite data...</p>
            </div>
        </div>
    </div>
    
    <!-- Error State -->
    <div id="analysisError" class="hidden analysis-card p-6">
        <div class="section-header">
            <div class="icon-badge bg-red-500 text-white">
                <i data-lucide="alert-triangle" class="w-5 h-5"></i>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-red-600">Analysis Failed</h3>
                <p class="text-gray-600" id="analysisErrorMessage">Unable to complete risk analysis</p>
            </div>
        </div>
        <button id="retryAnalysis" 
                class="bg-terra-green text-white px-4 py-2 rounded-lg hover:bg-terra-green-600 transition-colors flex items-center gap-2">
            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
            Try Again
        </button>
    </div>    <!-- Risk Analysis Results -->
    <div id="analysisResults" class="hidden space-y-6">
        <!-- Risk Overview -->
        <div class="analysis-card p-6">
            <div class="section-header">
                <div class="icon-badge bg-terra-green text-white">
                    <i data-lucide="activity" class="w-5 h-5"></i>
                </div>
                <div class="flex-1 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                    <div>
                        <h2 id="resultCropName" class="text-xl font-bold text-gray-900">Rice Analysis</h2>
                        <div class="text-sm text-gray-600" id="resultLocationInfo">
                            üìç Location ‚Ä¢ üìÖ Period
                        </div>
                    </div>
                    <span id="resultRiskBadge" class="risk-badge risk-medium">
                        ‚ö†Ô∏è Medium Risk
                    </span>
                </div>
            </div>
            <div id="resultSummary" class="bg-terra-green-50 border border-terra-green-200 rounded-lg p-4">
                <p class="text-terra-green-800 leading-relaxed">Risk analysis summary...</p>
            </div>
        </div>
        
        <!-- Alerts and Recommendations -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Alerts -->
            <div class="analysis-card p-6">
                <div class="section-header">
                    <div class="icon-badge bg-orange-500 text-white">
                        <i data-lucide="alert-circle" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Risk Alerts</h3>
                        <p class="text-sm text-gray-600"><span id="alertCount">0</span> issues detected</p>
                    </div>
                </div>
                <div id="resultAlerts" class="space-y-3">
                    <!-- Alerts populated by JavaScript -->
                </div>
            </div>
            
            <!-- Recommendations -->
            <div class="analysis-card p-6">
                <div class="section-header">
                    <div class="icon-badge bg-terra-blue text-white">
                        <i data-lucide="lightbulb" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Recommendations</h3>
                        <p class="text-sm text-gray-600">Actionable insights</p>
                    </div>
                </div>
                <div id="resultRecommendations" class="space-y-3">
                    <!-- Recommendations populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Data Sources -->
        <div class="analysis-card p-6">
            <div class="section-header">
                <div class="icon-badge bg-terra-green text-white">
                    <i data-lucide="satellite" class="w-5 h-5"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">NASA Data Sources</h3>
                    <p class="text-sm text-gray-600">Satellite data availability</p>
                </div>
            </div>
            <div id="resultDataSources" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- Data sources populated by JavaScript -->
            </div>
        </div>
    </div>
        
    <!-- Quick Examples -->
    <div class="analysis-card p-6">
        <div class="section-header">
            <div class="icon-badge bg-terra-blue text-white">
                <i data-lucide="zap" class="w-5 h-5"></i>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-900">Quick Analysis Examples</h3>
                <p class="text-sm text-gray-600">Try these pre-configured scenarios</p>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button class="example-btn p-4 border-2 border-gray-200 rounded-lg hover:border-terra-green hover:bg-terra-green-50 transition-all text-left"
                    data-lat="23.7644" data-lon="90.3897" data-crop="rice" data-location="Dhaka, Bangladesh">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                        <span class="text-lg">üáßüá©</span>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-900">Rice in Bangladesh</h4>
                        <p class="text-sm text-gray-600">Dhaka Region</p>
                    </div>
                </div>
                <p class="text-xs text-gray-500">Monsoon season analysis</p>
            </button>
            
            <button class="example-btn p-4 border-2 border-gray-200 rounded-lg hover:border-terra-green hover:bg-terra-green-50 transition-all text-left"
                    data-lat="28.6139" data-lon="77.2090" data-crop="wheat" data-location="Delhi, India">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                        <span class="text-lg">üáÆüá≥</span>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-900">Wheat in India</h4>
                        <p class="text-sm text-gray-600">Delhi Region</p>
                    </div>
                </div>
                <p class="text-xs text-gray-500">Winter crop analysis</p>
            </button>
            
            <button class="example-btn p-4 border-2 border-gray-200 rounded-lg hover:border-terra-green hover:bg-terra-green-50 transition-all text-left"
                    data-lat="44.0682" data-lon="-114.7420" data-crop="potato" data-location="Idaho, USA">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                        <span class="text-lg">üá∫üá∏</span>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-900">Potato in USA</h4>
                        <p class="text-sm text-gray-600">Idaho Region</p>
                    </div>
                </div>
                <p class="text-xs text-gray-500">Cool season analysis</p>
            </button>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    class RiskDashboard {
        constructor() {
            this.currentAnalysis = null;
            this.isAnalyzing = false;
            this.init();
        }

        init() {
            console.log('üåæ Risk Dashboard initialized');
            this.setupEventListeners();
            this.setDefaultDates();
        }

        setupEventListeners() {
            // Form submission
            const form = document.getElementById('riskAnalysisForm');
            if (form) {
                form.addEventListener('submit', (e) => this.handleFormSubmit(e));
            }

            // Example buttons
            document.querySelectorAll('.example-btn').forEach(btn => {
                btn.addEventListener('click', () => this.loadExample(btn));
            });

            // Retry button
            const retryBtn = document.getElementById('retryAnalysis');
            if (retryBtn) {
                retryBtn.addEventListener('click', () => this.retryLastAnalysis());
            }
        }

        setDefaultDates() {
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
        }

        handleFormSubmit(event) {
            event.preventDefault();
            
            const lat = document.getElementById('latitude').value;
            const lon = document.getElementById('longitude').value;
            const crop = document.getElementById('crop').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            console.log('Form submitted:', { lat, lon, crop, startDate, endDate });
            
            if (!this.validateInputs(lat, lon, crop, startDate, endDate)) {
                return;
            }
            
            this.analyzeRisk(lat, lon, crop, startDate, endDate);
        }

        loadExample(btn) {
            const lat = btn.dataset.lat;
            const lon = btn.dataset.lon;
            const crop = btn.dataset.crop;
            const location = btn.dataset.location;
            
            // Fill form
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lon;
            document.getElementById('crop').value = crop;
            
            // Use current dates
            this.setDefaultDates();
            
            // Analyze
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            this.analyzeRisk(lat, lon, crop, startDate, endDate, location);
        }

        validateInputs(lat, lon, crop, startDate, endDate) {
            if (!lat || !lon || !crop || !startDate || !endDate) {
                this.showError('Please fill in all required fields');
                return false;
            }
            
            const latitude = parseFloat(lat);
            const longitude = parseFloat(lon);
            
            if (isNaN(latitude) || latitude < -90 || latitude > 90) {
                this.showError('Latitude must be between -90 and 90');
                return false;
            }
            
            if (isNaN(longitude) || longitude < -180 || longitude > 180) {
                this.showError('Longitude must be between -180 and 180');
                return false;
            }
            
            return true;
        }

        async analyzeRisk(lat, lon, crop, startDate, endDate, locationName = null) {
            if (this.isAnalyzing) {
                console.log('Analysis already in progress, skipping...');
                return;
            }
            
            this.isAnalyzing = true;
            this.showLoading();
            
            try {
                const startStr = startDate.replace(/-/g, '');
                const endStr = endDate.replace(/-/g, '');
                
                const url = `/api/risk-alerts?lat=${lat}&lon=${lon}&crop=${crop}&start=${startStr}&end=${endStr}`;
                
                console.log(`üîç Analyzing risk: ${url}`);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üìä Risk analysis response:', data);
                
                if (data.success) {
                    this.currentAnalysis = {
                        ...data,
                        locationName: locationName || `${lat}¬∞, ${lon}¬∞`,
                        analysisTime: new Date().toISOString()
                    };
                    this.displayResults(this.currentAnalysis);
                } else {
                    throw new Error(data.error || 'Analysis failed');
                }
                
            } catch (error) {
                console.error('‚ùå Risk analysis error:', error);
                this.showError(`Analysis failed: ${error.message}`);
            } finally {
                this.isAnalyzing = false;
                this.hideLoading();
            }
        }

        displayResults(data) {
            console.log('üìã Displaying results:', data);
            this.hideError();
            
            // Update crop name and location
            document.getElementById('resultCropName').textContent = `${data.crop} Analysis`;
            document.getElementById('resultLocationInfo').textContent = 
                `üìç ${data.locationName} ‚Ä¢ üìÖ ${data.period.start} to ${data.period.end}`;
            
            // Update risk badge
            this.updateRiskBadge(data.risk_level);
            
            // Update summary
            this.updateSummary(data.summary);
            
            // Update alerts
            this.updateAlerts(data.alerts);
            
            // Update recommendations
            this.updateRecommendations(data.recommendations);
            
            // Update data sources
            this.updateDataSources(data.data_availability);
            
            // Show results
            document.getElementById('analysisResults').classList.remove('hidden');
            
            // Scroll to results
            document.getElementById('analysisResults').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
            
            console.log('‚úÖ Results displayed successfully');
        }

        updateRiskBadge(level) {
            const badge = document.getElementById('resultRiskBadge');
            if (!badge) return;
            
            const configs = {
                low: { emoji: '‚úÖ', label: 'Low Risk', classes: 'bg-green-100 text-green-800' },
                medium: { emoji: '‚ö†Ô∏è', label: 'Medium Risk', classes: 'bg-yellow-100 text-yellow-800' },
                high: { emoji: 'üö®', label: 'High Risk', classes: 'bg-red-100 text-red-800' }
            };
            
            const config = configs[level] || configs.medium;
            badge.textContent = `${config.emoji} ${config.label}`;
            badge.className = `px-3 py-1 text-sm font-semibold rounded-full ${config.classes}`;
        }

        updateSummary(summary) {
            const summaryEl = document.getElementById('resultSummary');
            if (summaryEl) {
                summaryEl.innerHTML = `<p class="text-terra-green-800 leading-relaxed">${summary}</p>`;
            }
        }

        updateAlerts(alerts) {
            const alertsEl = document.getElementById('resultAlerts');
            const countEl = document.getElementById('alertCount');
            
            if (!alertsEl || !countEl) return;
            
            countEl.textContent = alerts.length;
            
            if (alerts.length === 0) {
                alertsEl.innerHTML = '<div class="p-3 bg-green-50 text-green-800 rounded-lg">‚úÖ No risk alerts for this period</div>';
            } else {
                alertsEl.innerHTML = alerts.map(alert => 
                    `<div class="p-3 bg-orange-50 text-orange-800 rounded-lg border-l-4 border-orange-300">${alert}</div>`
                ).join('');
            }
        }

        updateRecommendations(recommendations) {
            const recEl = document.getElementById('resultRecommendations');
            if (!recEl) return;
            
            if (recommendations.length === 0) {
                recEl.innerHTML = '<div class="p-3 bg-green-50 text-green-800 rounded-lg">‚úÖ No specific recommendations needed</div>';
            } else {
                recEl.innerHTML = recommendations.map(rec => 
                    `<div class="p-3 bg-terra-green-50 text-terra-green-800 rounded-lg border-l-4 border-terra-green-300">${rec}</div>`
                ).join('');
            }
        }

        updateDataSources(sources) {
            const sourcesEl = document.getElementById('resultDataSources');
            if (!sourcesEl) return;
            
            sourcesEl.innerHTML = Object.entries(sources).map(([source, available]) => {
                const status = available ? 'text-green-600' : 'text-red-600';
                const icon = available ? '‚úÖ' : '‚ùå';
                return `<div class="flex items-center gap-2 ${status}">
                    <span>${icon}</span>
                    <span class="font-medium">${source}</span>
                </div>`;
            }).join('');
        }

        showLoading() {
            document.getElementById('analysisLoading').classList.remove('hidden');
            document.getElementById('analysisError').classList.add('hidden');
            document.getElementById('analysisResults').classList.add('hidden');
            
            // Update button state
            const btn = document.getElementById('analyzeBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Analyzing...';
            }
        }

        hideLoading() {
            document.getElementById('analysisLoading').classList.add('hidden');
            
            // Reset button state
            const btn = document.getElementById('analyzeBtn');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="search" class="w-4 h-4"></i> Analyze Crop Risk';
            }
        }

        showError(message) {
            const errorEl = document.getElementById('analysisError');
            const errorText = document.getElementById('analysisErrorMessage');
            
            if (errorEl && errorText) {
                errorText.textContent = message;
                errorEl.classList.remove('hidden');
            }
            
            this.hideLoading();
        }

        hideError() {
            const errorEl = document.getElementById('analysisError');
            if (errorEl) {
                errorEl.classList.add('hidden');
            }
        }

        retryLastAnalysis() {
            if (this.currentAnalysis) {
                // Extract form data and retry
                const lat = document.getElementById('latitude').value;
                const lon = document.getElementById('longitude').value;
                const crop = document.getElementById('crop').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                this.analyzeRisk(lat, lon, crop, startDate, endDate);
            }
        }
    }

    // Initialize on DOM load
    document.addEventListener('DOMContentLoaded', () => {
        window.riskDashboard = new RiskDashboard();
    });
</script>
{% endblock %}

