{% extends "base.html" %}

{% block title %}TerraPulse - Settings{% endblock %}
{% block subtitle %}App Settings{% endblock %}

{% block content %}
<div class="p-6 space-y-6 max-w-4xl mx-auto">
    <!-- Header Section -->
    <div class="bg-gradient-to-br from-slate-600 via-slate-700 to-gray-800 rounded-2xl p-8 text-white shadow-xl">
        <div class="flex items-center gap-6">
            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                <i data-lucide="settings" class="w-6 h-6 text-white"></i>
            </div>
            <div>
                <h2 class="text-3xl font-display font-bold">Settings</h2>
                <p class="text-slate-100 mt-1 text-lg">Customize your TerraPulse experience</p>
            </div>
        </div>
    </div>

    <!-- Profile Section -->
    <div class="card-light p-6">
        <div class="flex items-center gap-8 mb-6">
            <div class="w-16 h-16 bg-terra-green rounded-full flex items-center justify-center">
                <span class="text-white text-2xl font-bold">{{ user.full_name[0].upper() if user.full_name else user.username[0].upper() }}</span>
            </div>
            <div>
                <h3 class="text-xl font-semibold text-gray-900">{{ user.full_name or user.username }}</h3>
                <p class="text-sm text-gray-600 mt-1">{{ user.profile_type.title() if user.profile_type else 'User' }} • {{ user.district or user.location or 'Location not set' }}</p>
                <p class="text-xs text-gray-400 mt-1">Member since October 2025</p>
            </div>
        </div>
        <button id="edit-profile-btn" class="btn-light-outline w-full">
            Edit Profile
        </button>
    </div>

    <!-- Notification Settings -->
    <div class="card-light p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Notifications</h3>
        <div class="space-y-4">
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                <div>
                    <p class="text-sm font-medium text-gray-900">Weather Alerts</p>
                    <p class="text-xs text-gray-500">Get notified about severe weather conditions</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-terra-green peer-focus:ring-opacity-20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-terra-green"></div>
                </label>
            </div>

            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-900">Risk Score Updates</p>
                    <p class="text-xs text-gray-500">Alerts when environmental risk scores change</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-terra-green peer-focus:ring-opacity-20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-terra-green"></div>
                </label>
            </div>

            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-900">Community Posts</p>
                    <p class="text-xs text-gray-500">New posts from agricultural community</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-terra-green peer-focus:ring-opacity-20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-terra-green"></div>
                </label>
            </div>

            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-900">Market Price Updates</p>
                    <p class="text-xs text-gray-500">Daily market price notifications</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-terra-green peer-focus:ring-opacity-20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-terra-green"></div>
                </label>
            </div>

            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-900">Training & Workshops</p>
                    <p class="text-xs text-gray-500">Agricultural training opportunities</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-terra-green peer-focus:ring-opacity-20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-terra-green"></div>
                </label>
            </div>
        </div>
    </div>

    <!-- App Preferences -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">App Preferences</h3>
        <div class="space-y-4">
            <!-- Dark Mode -->
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-900">Dark Mode</p>
                    <p class="text-xs text-gray-500">Switch to dark theme</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-terra-green peer-focus:ring-opacity-20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-gray-600"></div>
                </label>
            </div>

            <!-- Language -->
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-900">Language</p>
                    <p class="text-xs text-gray-500">Choose your preferred language</p>
                </div>
                <select class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-terra-green text-sm">
                    <option>English</option>
                    <option>বাংলা (Bengali)</option>
                    <option>हिन्दी (Hindi)</option>
                </select>
            </div>

            <!-- Units -->
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-900">Measurement Units</p>
                    <p class="text-xs text-gray-500">Temperature and measurement preferences</p>
                </div>
                <select class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-terra-green text-sm">
                    <option>Metric (°C, km)</option>
                    <option>Imperial (°F, miles)</option>
                </select>
            </div>

            <!-- Auto Sync -->
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-900">Auto Sync</p>
                    <p class="text-xs text-gray-500">Automatically sync data when connected</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-terra-green peer-focus:ring-opacity-20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-terra-green"></div>
                </label>
            </div>
        </div>
    </div>

    <!-- Data & Privacy -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Data & Privacy</h3>
        <div class="space-y-3">
            <button class="w-full flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <div class="flex items-center space-x-3">
                    <i data-lucide="download" class="w-5 h-5 text-gray-600"></i>
                    <span class="text-sm font-medium text-gray-900">Download My Data</span>
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
            </button>
            
            <button class="w-full flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <div class="flex items-center space-x-3">
                    <i data-lucide="shield" class="w-5 h-5 text-gray-600"></i>
                    <span class="text-sm font-medium text-gray-900">Privacy Policy</span>
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
            </button>
            
            <button class="w-full flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <div class="flex items-center space-x-3">
                    <i data-lucide="file-text" class="w-5 h-5 text-gray-600"></i>
                    <span class="text-sm font-medium text-gray-900">Terms of Service</span>
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
            </button>
            
            <button class="w-full flex items-center justify-between p-3 bg-red-50 rounded-lg hover:bg-red-100 transition-colors border border-red-200">
                <div class="flex items-center space-x-3">
                    <i data-lucide="trash-2" class="w-5 h-5 text-red-600"></i>
                    <span class="text-sm font-medium text-red-700">Delete Account</span>
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 text-red-400"></i>
            </button>
        </div>
    </div>

    <!-- Location Settings -->
        <!-- Location Settings -->
    <div class="card-light p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Location & Farm Info</h3>
        <form id="location-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Primary Farm Location</label>
                <select id="district-select" name="district" class="input-light w-full">
                    <option value="">Select District</option>
                    <option value="Dhaka District" {{ 'selected' if user.district == 'Dhaka District' else '' }}>Dhaka District</option>
                    <option value="Chittagong District" {{ 'selected' if user.district == 'Chittagong District' else '' }}>Chittagong District</option>
                    <option value="Sylhet District" {{ 'selected' if user.district == 'Sylhet District' else '' }}>Sylhet District</option>
                    <option value="Rajshahi District" {{ 'selected' if user.district == 'Rajshahi District' else '' }}>Rajshahi District</option>
                    <option value="Khulna District" {{ 'selected' if user.district == 'Khulna District' else '' }}>Khulna District</option>
                    <option value="Barisal District" {{ 'selected' if user.district == 'Barisal District' else '' }}>Barisal District</option>
                    <option value="Rangpur District" {{ 'selected' if user.district == 'Rangpur District' else '' }}>Rangpur District</option>
                    <option value="Mymensingh District" {{ 'selected' if user.district == 'Mymensingh District' else '' }}>Mymensingh District</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Primary Crop</label>
                <select id="crop-select" name="primary_crop" class="input-light w-full">
                    <option value="">Select Primary Crop</option>
                    <option value="Rice" {{ 'selected' if user.primary_crop == 'Rice' else '' }}>Rice</option>
                    <option value="Wheat" {{ 'selected' if user.primary_crop == 'Wheat' else '' }}>Wheat</option>
                    <option value="Potato" {{ 'selected' if user.primary_crop == 'Potato' else '' }}>Potato</option>
                    <option value="Jute" {{ 'selected' if user.primary_crop == 'Jute' else '' }}>Jute</option>
                    <option value="Maize" {{ 'selected' if user.primary_crop == 'Maize' else '' }}>Maize</option>
                    <option value="Tomato" {{ 'selected' if user.primary_crop == 'Tomato' else '' }}>Tomato</option>
                    <option value="Mixed Crops" {{ 'selected' if user.primary_crop == 'Mixed Crops' else '' }}>Mixed Crops</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Farm Size (hectares)</label>
                <input type="number" 
                       id="farm-size-input"
                       name="farm_size"
                       class="input-light w-full" 
                       placeholder="2.5" 
                       step="0.1" 
                       min="0"
                       value="{{ user.farm_size if user.farm_size else '' }}">
            </div>
        </form>
        <button id="save-location-btn" class="btn-terra-primary w-full mt-4">
            Save Location Settings
        </button>
    </div>

    <!-- App Information -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">App Information</h3>
        <div class="space-y-3">
            <div class="flex items-center justify-between py-2">
                <span class="text-sm text-gray-600">App Version</span>
                <span class="text-sm font-medium text-gray-900">2.1.0</span>
            </div>
            <div class="flex items-center justify-between py-2">
                <span class="text-sm text-gray-600">Last Updated</span>
                <span class="text-sm font-medium text-gray-900">September 25, 2025</span>
            </div>
            <div class="flex items-center justify-between py-2">
                <span class="text-sm text-gray-600">Data Usage</span>
                <span class="text-sm font-medium text-gray-900">45.2 MB</span>
            </div>
            <div class="flex items-center justify-between py-2">
                <span class="text-sm text-gray-600">Cache Size</span>
                <span class="text-sm font-medium text-gray-900">12.8 MB</span>
            </div>
        </div>
        
        <div class="grid grid-cols-2 gap-3 mt-4 pt-4 border-t border-gray-100">
            <button class="flex items-center justify-center space-x-2 py-3 bg-blue-50 border border-blue-200 rounded-lg text-blue-700 hover:bg-blue-100 transition-colors">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                <span class="text-sm font-medium">Check Updates</span>
            </button>
            <button class="flex items-center justify-center space-x-2 py-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
                <span class="text-sm font-medium">Clear Cache</span>
            </button>
        </div>
    </div>

    <!-- Support -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Support & Feedback</h3>
        <div class="space-y-3">
            <button class="w-full flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <div class="flex items-center space-x-3">
                    <i data-lucide="help-circle" class="w-5 h-5 text-gray-600"></i>
                    <span class="text-sm font-medium text-gray-900">Help Center</span>
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
            </button>
            
            <button class="w-full flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <div class="flex items-center space-x-3">
                    <i data-lucide="message-circle" class="w-5 h-5 text-gray-600"></i>
                    <span class="text-sm font-medium text-gray-900">Contact Support</span>
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
            </button>
            
            <button class="w-full flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <div class="flex items-center space-x-3">
                    <i data-lucide="star" class="w-5 h-5 text-gray-600"></i>
                    <span class="text-sm font-medium text-gray-900">Rate TerraPulse</span>
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
            </button>
            
            <button class="w-full flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <div class="flex items-center space-x-3">
                    <i data-lucide="share-2" class="w-5 h-5 text-gray-600"></i>
                    <span class="text-sm font-medium text-gray-900">Share App</span>
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
            </button>
        </div>
    </div>

    <!-- Sign Out -->
    <div class="card-light p-6">
        <button id="logout-btn" class="w-full py-3 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition-colors flex items-center justify-center space-x-2">
            <i data-lucide="log-out" class="w-5 h-5"></i>
            <span>Sign Out</span>
        </button>
    </div>
</div>

<script>
    // Toggle switches functionality
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            // Add haptic feedback for mobile
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
            
            // You can add actual settings save functionality here
            console.log(`Setting ${this.closest('.flex').querySelector('p').textContent} changed to:`, this.checked);
        });
    });
    
    // Location save functionality
    document.getElementById('save-location-btn').addEventListener('click', async function(e) {
        e.preventDefault();
        
        const button = this;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'Saving...';
        
        try {
            const formData = new FormData(document.getElementById('location-form'));
            const data = Object.fromEntries(formData.entries());
            
            const response = await fetch('/api/profile/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                button.textContent = 'Saved!';
                button.className = 'btn-terra-primary w-full mt-4 bg-green-600';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.className = 'btn-terra-primary w-full mt-4';
                    button.disabled = false;
                }, 2000);
                
                // Show success notification
                showNotification('Location settings saved successfully!', 'success');
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('Save error:', error);
            button.textContent = 'Error - Try Again';
            button.className = 'btn-terra-primary w-full mt-4 bg-red-600';
            setTimeout(() => {
                button.textContent = originalText;
                button.className = 'btn-terra-primary w-full mt-4';
                button.disabled = false;
            }, 3000);
            
            showNotification('Failed to save location settings', 'error');
        }
    });
    
    // Edit profile functionality
    document.getElementById('edit-profile-btn').addEventListener('click', function() {
        // Create a simple modal for editing profile
        const modal = createProfileEditModal();
        document.body.appendChild(modal);
    });
    
    // Toggle switches functionality with backend sync
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', async function() {
            // Add haptic feedback for mobile
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
            
            const settingName = this.closest('.flex').querySelector('p').textContent;
            console.log(`Setting ${settingName} changed to:`, this.checked);
            
            // Sync notification settings to backend
            try {
                const notificationSettings = {};
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    const name = cb.closest('.flex').querySelector('p').textContent.toLowerCase().replace(/\s+/g, '_');
                    notificationSettings[name] = cb.checked;
                });
                
                await fetch('/api/settings/notifications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(notificationSettings)
                });
            } catch (error) {
                console.error('Failed to sync notification settings:', error);
            }
        });
    });
    
    // Helper function to create profile edit modal
    function createProfileEditModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">Edit Profile</h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <form id="profile-edit-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                        <input type="text" name="full_name" class="input-light w-full" value="{{ user.full_name or '' }}" placeholder="Enter your full name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                        <input type="text" name="location" class="input-light w-full" value="{{ user.location or '' }}" placeholder="Enter your location">
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="button" id="cancel-edit" class="btn-light-outline flex-1">Cancel</button>
                        <button type="submit" class="btn-terra-primary flex-1">Save Changes</button>
                    </div>
                </form>
            </div>
        `;
        
        // Add event listeners
        modal.querySelector('#close-modal').addEventListener('click', () => modal.remove());
        modal.querySelector('#cancel-edit').addEventListener('click', () => modal.remove());
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
        
        modal.querySelector('#profile-edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch('/api/profile/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('Profile updated successfully!', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showNotification('Failed to update profile', 'error');
            }
        });
        
        // Initialize Lucide icons for the modal
        setTimeout(() => lucide.createIcons(), 100);
        
        return modal;
    }
    
    // Notification helper
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
        notification.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 100);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    // Logout functionality
    document.getElementById('logout-btn').addEventListener('click', async function(e) {
        e.preventDefault();
        
        // Add confirmation dialog
        const confirmLogout = confirm('Are you sure you want to sign out? You will need to log in again to access your account.');
        if (!confirmLogout) {
            return;
        }
        
        // Add loading state
        const button = this;
        const originalContent = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i><span>Signing out...</span>';
        
        // Reinitialize lucide icons for the new loader icon
        lucide.createIcons();
        
        try {
            const response = await fetch('/auth/api/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include'
            });
            
            // Clear all local storage and session storage
            sessionStorage.clear();
            localStorage.clear();
            
            // Clear any cached data
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            
            if (response.ok) {
                const result = await response.json();
                console.log('Logout successful:', result.message);
                
                // Show success message briefly before redirect
                button.innerHTML = '<i data-lucide="check" class="w-5 h-5"></i><span>Signed out!</span>';
                button.className = 'w-full py-3 bg-green-600 text-white rounded-lg font-medium flex items-center justify-center space-x-2';
                
                // Reinitialize lucide icons for the check icon
                lucide.createIcons();
                
                setTimeout(() => {
                    window.location.href = '/auth/login';
                }, 1000);
            } else {
                console.warn('Logout response not ok, but redirecting anyway');
                window.location.href = '/auth/login';
            }
        } catch (error) {
            console.error('Logout error:', error);
            // Clear storage and redirect anyway
            sessionStorage.clear();
            localStorage.clear();
            window.location.href = '/auth/login';
        } finally {
            // Reset button state if still on page
            setTimeout(() => {
                if (button) {
                    button.disabled = false;
                    button.innerHTML = originalContent;
                    button.className = 'w-full py-3 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition-colors flex items-center justify-center space-x-2';
                    lucide.createIcons();
                }
            }, 2000);
        }
    });
</script>
{% endblock %}