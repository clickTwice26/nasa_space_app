{% extends "base.html" %}

{% block title %}TerraPulse - Predictions{% endblock %}
{% block subtitle %}Environmental Predictions{% endblock %}

{% block content %}
<div class="space-y-4 pb-32">
    <!-- Header Card -->
    <div class="card bg-gradient-to-br from-purple-500 to-purple-600 text-white border-purple-300">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-lg font-semibold mb-1">Crop Risk Prediction</h2>
                <p class="text-sm opacity-90">AI-powered agricultural insights</p>
            </div>
            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                <i data-lucide="brain" class="w-6 h-6"></i>
            </div>
        </div>
    </div>

    <!-- Prediction Form -->
    <div class="card">
        <h3 class="font-semibold text-gray-900 mb-4">Prediction Parameters</h3>
        
        <!-- Crop Selection -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-3">Select Crop</label>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                <button class="crop-btn p-4 border border-gray-300 rounded-xl text-center hover:border-terra-green-500 hover:bg-terra-green-50 transition-all active:scale-95 touch-manipulation" data-crop="rice">
                    <i data-lucide="wheat" class="w-6 h-6 mx-auto mb-2 text-green-600"></i>
                    <div class="text-sm font-medium">Rice</div>
                </button>
                <button class="crop-btn p-4 border border-gray-300 rounded-xl text-center hover:border-terra-green-500 hover:bg-terra-green-50 transition-all active:scale-95 touch-manipulation" data-crop="wheat">
                    <i data-lucide="wheat" class="w-6 h-6 mx-auto mb-2 text-yellow-600"></i>
                    <div class="text-sm font-medium">Wheat</div>
                </button>
                <button class="crop-btn p-4 border border-gray-300 rounded-xl text-center hover:border-terra-green-500 hover:bg-terra-green-50 transition-all active:scale-95 touch-manipulation" data-crop="corn">
                    <i data-lucide="corn" class="w-6 h-6 mx-auto mb-2 text-orange-600"></i>
                    <div class="text-sm font-medium">Corn</div>
                </button>
                <button class="crop-btn p-4 border border-gray-300 rounded-xl text-center hover:border-terra-green-500 hover:bg-terra-green-50 transition-all active:scale-95 touch-manipulation" data-crop="sugarcane">
                    <i data-lucide="leaf" class="w-6 h-6 mx-auto mb-2 text-green-700"></i>
                    <div class="text-sm font-medium">Sugarcane</div>
                </button>
            </div>
        </div>

        <!-- Season Selection -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-3">Season</label>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                <button class="season-btn p-4 border border-gray-300 rounded-xl text-center hover:border-blue-500 hover:bg-blue-50 transition-all active:scale-95 touch-manipulation" data-season="kharif-i">
                    <div class="text-sm font-medium mb-1">Kharif-I</div>
                    <div class="text-xs text-gray-600">Mid-Mar to Mid-Jul</div>
                </button>
                <button class="season-btn p-4 border border-gray-300 rounded-xl text-center hover:border-orange-500 hover:bg-orange-50 transition-all active:scale-95 touch-manipulation" data-season="kharif-ii">
                    <div class="text-sm font-medium mb-1">Kharif-II</div>
                    <div class="text-xs text-gray-600">Mid-Jul to Mid-Nov</div>
                </button>
                <button class="season-btn p-4 border border-gray-300 rounded-xl text-center hover:border-green-500 hover:bg-green-50 transition-all active:scale-95 touch-manipulation" data-season="rabi">
                    <div class="text-sm font-medium mb-1">Rabi</div>
                    <div class="text-xs text-gray-600">Mid-Nov to Mid-Mar</div>
                </button>
            </div>
        </div>

        <!-- Location -->
        <div class="mb-6">
            <label for="predictionLocation" class="block text-sm font-medium text-gray-700 mb-3">Location</label>
            <div class="space-y-4">
                <div class="flex gap-3">
                    <input type="text" id="predictionLocation" placeholder="Enter coordinates (lat, lon) or city name" 
                           class="flex-1 rounded-xl border border-gray-300 px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors">
                    <button type="button" onclick="getCurrentLocation()" 
                            class="px-4 py-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition-colors active:scale-95 touch-manipulation flex-shrink-0">
                        <i data-lucide="map-pin" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button type="button" onclick="setLocation('23.8103, 90.4125', 'Dhaka, Bangladesh')" 
                            class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200 transition-colors active:scale-95 touch-manipulation">
                        Dhaka
                    </button>
                    <button type="button" onclick="setLocation('22.3569, 91.7832', 'Chittagong, Bangladesh')" 
                            class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200 transition-colors active:scale-95 touch-manipulation">
                        Chittagong
                    </button>
                    <button type="button" onclick="setLocation('24.3636, 88.6241', 'Rajshahi, Bangladesh')" 
                            class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200 transition-colors active:scale-95 touch-manipulation">
                        Rajshahi
                    </button>
                    <button type="button" onclick="setLocation('24.8949, 91.8687', 'Sylhet, Bangladesh')" 
                            class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200 transition-colors active:scale-95 touch-manipulation">
                        Sylhet
                    </button>
                </div>
            </div>
        </div>

        <!-- Analyze Button -->
        <button onclick="makePrediction()" class="btn btn-primary w-full py-4 text-lg font-medium rounded-xl active:scale-95 touch-manipulation">
            <i data-lucide="brain" class="w-5 h-5"></i>
            <span>Analyze Risk</span>
        </button>
    </div>

    <!-- NASA Weather Integration -->
    <div class="card">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i data-lucide="satellite" class="w-5 h-5 text-blue-600"></i>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-900">NASA Weather Data</h3>
                    <p class="text-sm text-gray-600">Real-time environmental data</p>
                </div>
            </div>
            <button onclick="loadNASAWeatherData()" class="btn btn-sm btn-outline">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
            </button>
        </div>
        
        <div id="nasa-weather-container" class="bg-gray-50 rounded-xl p-6 border border-gray-200">
            <div class="text-center">
                <i data-lucide="satellite" class="w-10 h-10 text-gray-400 mx-auto mb-3"></i>
                <p class="text-base text-gray-600">Click refresh to load NASA weather data</p>
            </div>
        </div>
    </div>

    <!-- Prediction Result Modal -->
    <div id="predictionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-end sm:items-center justify-center p-0 sm:p-4" onclick="closePredictionModal()">
        <div class="bg-white rounded-t-3xl sm:rounded-xl w-full sm:max-w-lg sm:w-full max-h-[95vh] sm:max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="sticky top-0 bg-white rounded-t-3xl sm:rounded-t-xl border-b border-gray-200 p-4 sm:p-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                            <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900">Prediction Results</h3>
                    </div>
                    <button onclick="closePredictionModal()" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-gray-100 transition-colors touch-manipulation">
                        <i data-lucide="x" class="w-6 h-6 text-gray-500"></i>
                    </button>
                </div>
                <!-- Mobile drag indicator -->
                <div class="sm:hidden w-12 h-1 bg-gray-300 rounded-full mx-auto mt-2"></div>
            </div>
            
            <div id="predictionModalContent" class="p-4 sm:p-6 pb-8 sm:pb-6">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>
            

    <!-- Recent Predictions -->
    <div class="card mb-8">
        <h3 class="font-semibold text-gray-900 mb-4">Recent Predictions</h3>
        <div class="space-y-3" id="recentPredictions">
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-200 active:bg-gray-100 transition-colors touch-manipulation">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <i data-lucide="wheat" class="w-5 h-5 text-green-600"></i>
                    </div>
                    <div class="min-w-0 flex-1">
                        <div class="font-medium text-sm text-gray-900 truncate">Rice - Kharif-I Season</div>
                        <div class="text-xs text-gray-600 truncate">Dhaka District</div>
                    </div>
                </div>
                <div class="text-right flex-shrink-0">
                    <div class="text-sm font-medium text-green-700">Low Risk</div>
                    <div class="text-xs text-gray-500">2 hours ago</div>
                </div>
            </div>
            
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-200 active:bg-gray-100 transition-colors touch-manipulation">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <i data-lucide="wheat" class="w-5 h-5 text-yellow-600"></i>
                    </div>
                    <div class="min-w-0 flex-1">
                        <div class="font-medium text-sm text-gray-900 truncate">Wheat - Rabi Season</div>
                        <div class="text-xs text-gray-600 truncate">Chittagong District</div>
                    </div>
                </div>
                <div class="text-right flex-shrink-0">
                    <div class="text-sm font-medium text-yellow-700">Medium Risk</div>
                    <div class="text-xs text-gray-500">1 day ago</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedCrop = '';
let selectedSeason = '';

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Lucide icons
    lucide.createIcons();
    
    // Crop selection
    document.querySelectorAll('.crop-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Remove active class from all crop buttons
            document.querySelectorAll('.crop-btn').forEach(b => b.classList.remove('border-terra-green-500', 'bg-terra-green-50'));
            
            // Add active class to clicked button
            this.classList.add('border-terra-green-500', 'bg-terra-green-50');
            selectedCrop = this.dataset.crop;
        });
    });

    // Season selection
    document.querySelectorAll('.season-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Remove active class from all season buttons
            document.querySelectorAll('.season-btn').forEach(b => b.classList.remove('border-blue-500', 'bg-blue-50'));
            
            // Add active class to clicked button
            this.classList.add('border-blue-500', 'bg-blue-50');
            selectedSeason = this.dataset.season;
        });
    });
});

async function getCurrentLocation() {
    const locationInput = document.getElementById('predictionLocation');
    
    if (!navigator.geolocation) {
        showLocationError('Geolocation is not supported by this browser. Please enter coordinates manually or use the preset locations.');
        return;
    }

    locationInput.value = 'Getting location...';

    navigator.geolocation.getCurrentPosition(
        async (position) => {
            const lat = position.coords.latitude.toFixed(6);
            const lon = position.coords.longitude.toFixed(6);
            
            try {
                // Try to get location name using OpenStreetMap Nominatim (free service)
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.display_name) {
                        // Extract meaningful location parts
                        const address = data.address || {};
                        const city = address.city || address.town || address.village || address.county;
                        const state = address.state || address.province;
                        const country = address.country;
                        
                        let locationName = '';
                        if (city && state) {
                            locationName = `${city}, ${state}`;
                        } else if (city && country) {
                            locationName = `${city}, ${country}`;
                        } else if (state && country) {
                            locationName = `${state}, ${country}`;
                        } else {
                            locationName = data.display_name.split(',').slice(0, 3).join(', ');
                        }
                        
                        locationInput.value = `${lat}, ${lon}`;
                        locationInput.placeholder = locationName;
                        showLocationSuccess(`Location found: ${locationName}`);
                    } else {
                        locationInput.value = `${lat}, ${lon}`;
                        showLocationSuccess('Location coordinates obtained');
                    }
                } else {
                    locationInput.value = `${lat}, ${lon}`;
                    showLocationSuccess('Location coordinates obtained');
                }
            } catch (error) {
                console.log('Reverse geocoding failed, using coordinates:', error);
                locationInput.value = `${lat}, ${lon}`;
                showLocationSuccess('Location coordinates obtained');
            }
        },
        (error) => {
            locationInput.value = '';
            let errorMessage = 'Unable to get your location. ';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += 'Location access was denied. Please enable location permissions in your browser or use the preset locations below.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += 'Location information is unavailable. Please enter coordinates manually or use the preset locations.';
                    break;
                case error.TIMEOUT:
                    errorMessage += 'Location request timed out. Please try again or enter coordinates manually.';
                    break;
                default:
                    errorMessage += 'An unknown error occurred. Please enter coordinates manually.';
                    break;
            }
            
            showLocationError(errorMessage);
        },
        {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 300000
        }
    );
}

function setLocation(coords, name) {
    const locationInput = document.getElementById('predictionLocation');
    locationInput.value = coords;
    locationInput.placeholder = name;
    showLocationSuccess(`Location set to: ${name}`);
}

function showLocationSuccess(message) {
    // Create a temporary success message
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

function showLocationError(message) {
    // Create a temporary error message
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 max-w-sm';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}

async function makePrediction() {
    if (!selectedCrop || !selectedSeason) {
        alert('Please select a crop and season');
        return;
    }

    const location = document.getElementById('predictionLocation').value;
    if (!location) {
        alert('Please enter a location');
        return;
    }

    // Show loading state in modal
    const modal = document.getElementById('predictionModal');
    const modalContent = document.getElementById('predictionModalContent');
    
    modalContent.innerHTML = `
        <div class="text-center py-8">
            <div class="w-12 h-12 bg-gray-200 rounded-full animate-pulse mx-auto mb-4"></div>
            <h4 class="text-lg font-medium text-gray-900 mb-2">Analyzing Crop Risk</h4>
            <p class="text-sm text-gray-600">Using NASA satellite data and AI models...</p>
            <div class="mt-4 bg-gray-100 rounded-full h-2">
                <div class="bg-terra-green-500 h-2 rounded-full animate-pulse" style="width: 60%;"></div>
            </div>
        </div>
    `;
    
    // Show the modal
    modal.classList.remove('hidden');

    try {
        const response = await fetch('/api/predict', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                crop: selectedCrop,
                season: selectedSeason,
                location: location
            })
        });

        if (!response.ok) throw new Error('Prediction failed');

        const data = await response.json();
        displayPredictionResult(data);

    } catch (error) {
        console.error('Prediction error:', error);
        const modalContent = document.getElementById('predictionModalContent');
        modalContent.innerHTML = `
            <div class="text-center py-8">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="alert-circle" class="w-6 h-6 text-red-500"></i>
                </div>
                <h4 class="text-lg font-medium text-gray-900 mb-2">Prediction Failed</h4>
                <p class="text-sm text-gray-600 mb-4">We couldn't generate a prediction. Please try again.</p>
                <div class="flex gap-3">
                    <button onclick="closePredictionModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        Close
                    </button>
                    <button onclick="closePredictionModal(); makePrediction();" class="flex-1 px-4 py-2 bg-terra-green-500 text-white rounded-lg hover:bg-terra-green-600 transition-colors">
                        Try Again
                    </button>
                </div>
            </div>
        `;
        lucide.createIcons();
    }
}

function displayPredictionResult(data) {
    const modalContent = document.getElementById('predictionModalContent');
    
    // Extract prediction data
    const prediction = data.prediction || data;
    const riskAssessment = prediction.risk_assessment || {};
    const yieldPrediction = prediction.yield_prediction || {};
    const location = prediction.location || {};
    const recommendations = prediction.recommendations || [];
    
    // Risk level display
    const riskLevel = riskAssessment.level || 'Medium';
    const riskScore = riskAssessment.score || 50;
    const riskColor = riskScore < 30 ? 'green' : riskScore < 70 ? 'yellow' : 'red';
    const confidence = Math.round((prediction.confidence || 0.85) * 100);
    
    modalContent.innerHTML = `
        <!-- Header with Crop and Location -->
        <div class="bg-gradient-to-r from-terra-green-50 to-blue-50 rounded-lg p-4 border border-terra-green-200 mb-4">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-xl font-bold text-terra-green-700">${prediction.crop || 'Crop'} Prediction</h3>
                <span class="bg-terra-green-100 text-terra-green-700 px-3 py-1 rounded-full text-sm font-medium">
                    ${prediction.season || 'Season'} Season
                </span>
            </div>
            <div class="text-sm text-gray-600">
                <i data-lucide="map-pin" class="w-4 h-4 inline mr-1"></i>
                ${location.name || `${location.latitude}, ${location.longitude}`}
            </div>
            <div class="text-xs text-gray-500 mt-1">
                Generated: ${new Date(prediction.generated_at || Date.now()).toLocaleString()}
            </div>
        </div>

        <!-- Yield Prediction -->
        <div class="bg-blue-50 rounded-xl p-4 sm:p-6 border border-blue-200 mb-4">
            <h4 class="font-medium text-blue-900 mb-4 flex items-center">
                <i data-lucide="trending-up" class="w-5 h-5 mr-2"></i>
                Yield Prediction
            </h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="bg-white rounded-xl p-4 border border-blue-100 text-center">
                    <div class="text-3xl font-bold text-blue-700 mb-1">${yieldPrediction.per_hectare || 0}</div>
                    <div class="text-sm text-blue-600">tons/hectare</div>
                </div>
                <div class="bg-white rounded-xl p-4 border border-blue-100 text-center">
                    <div class="text-3xl font-bold text-blue-700 mb-1">${yieldPrediction.total_yield || 0}</div>
                    <div class="text-sm text-blue-600">total yield (${yieldPrediction.unit || 'tons'})</div>
                </div>
            </div>
            <div class="mt-4 text-center">
                <span class="bg-blue-100 text-blue-700 px-4 py-2 rounded-full text-sm font-medium">
                    ${confidence}% Confidence
                </span>
            </div>
        </div>

        <!-- Risk Assessment -->
        <div class="bg-gradient-to-r from-${riskColor}-50 to-orange-50 rounded-lg p-4 border border-${riskColor}-200 mb-4">
            <h4 class="font-medium text-${riskColor}-900 mb-3 flex items-center">
                <i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i>
                Risk Assessment
            </h4>
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-2xl font-bold text-${riskColor}-700">${riskLevel} Risk</div>
                    <div class="text-sm text-${riskColor}-600">Risk Score: ${riskScore}/100</div>
                </div>
                <div class="w-16 h-16 relative">
                    <svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36">
                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                              fill="none" stroke="#e5e7eb" stroke-width="3"/>
                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                              fill="none" stroke="${riskColor === 'green' ? '#10b981' : riskColor === 'yellow' ? '#f59e0b' : '#ef4444'}" 
                              stroke-width="3" stroke-dasharray="${riskScore}, 100"/>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center text-xs font-semibold text-gray-900">${riskScore}%</div>
                </div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="bg-green-50 rounded-lg p-4 border border-green-200 mb-4">
            <h4 class="font-medium text-green-900 mb-3 flex items-center">
                <i data-lucide="lightbulb" class="w-5 h-5 mr-2"></i>
                Recommendations
            </h4>
            <div class="space-y-2">
                ${recommendations.map((rec, index) => `
                    <div class="flex items-start gap-3 p-3 bg-white rounded-lg border border-green-100">
                        <div class="w-6 h-6 bg-green-100 text-green-700 rounded-full flex items-center justify-center text-sm font-medium flex-shrink-0">
                            ${index + 1}
                        </div>
                        <div class="text-sm text-green-800">${rec}</div>
                    </div>
                `).join('')}
            </div>
        </div>

        <!-- Area Coverage -->
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 mb-4">
            <h4 class="font-medium text-gray-900 mb-2 flex items-center">
                <i data-lucide="square" class="w-5 h-5 mr-2"></i>
                Coverage Area
            </h4>
            <div class="text-lg font-semibold text-gray-700">
                ${prediction.area_hectares || 1} hectares
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-3 pt-6 border-t border-gray-200">
            <button onclick="closePredictionModal()" class="flex-1 px-6 py-4 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-medium text-base active:scale-95 touch-manipulation">
                Close
            </button>
            <button onclick="sharePrediction()" class="flex-1 px-6 py-4 bg-terra-green-500 text-white rounded-xl hover:bg-terra-green-600 transition-colors font-medium text-base active:scale-95 touch-manipulation">
                Share Results
            </button>
        </div>
    `;
    
    // Show the modal
    document.getElementById('predictionModal').classList.remove('hidden');
    
    // Re-initialize Lucide icons
    lucide.createIcons();
}

function closePredictionModal() {
    document.getElementById('predictionModal').classList.add('hidden');
}

function sharePrediction() {
    // Implement share functionality
    if (navigator.share) {
        navigator.share({
            title: 'TerraPulse Crop Risk Prediction',
            text: 'Check out my crop risk analysis from TerraPulse!',
            url: window.location.href
        });
    } else {
        // Fallback: Copy to clipboard
        navigator.clipboard.writeText(window.location.href).then(() => {
            alert('Link copied to clipboard!');
        });
    }
}

async function loadNASAWeatherData() {
    const container = document.getElementById('nasa-weather-container');
    
    container.innerHTML = `
        <div class="flex items-center justify-center py-4">
            <div class="w-6 h-6 bg-gray-300 rounded-full animate-pulse mr-3"></div>
            <span class="text-sm text-gray-600">Loading NASA weather data...</span>
        </div>
    `;
    
    try {
        const response = await fetch('/api/nasa-weather');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            displayNASAWeatherData(data);
        } else {
            throw new Error(data.error || 'Failed to load NASA weather data');
        }
        
    } catch (error) {
        console.error('NASA weather data error:', error);
        
        // Show demo data as fallback
        const demoData = {
            parameters: {
                temperature_2m: { value: '24.5', unit: '°C' },
                humidity: { value: '68', unit: '%' },
                precipitation: { value: '2.3', unit: 'mm/day' },
                solar_radiation: { value: '18.5', unit: 'MJ/m²/day' },
                wind_speed: { value: '3.2', unit: 'm/s' }
            },
            quality: 'Demo Data',
            data_source: 'NASA POWER API (Demo)',
            timestamp: new Date().toISOString()
        };
        
        displayNASAWeatherData(demoData);
    }
}

function displayNASAWeatherData(data) {
    const container = document.getElementById('nasa-weather-container');
    
    // Extract data from the nested structure
    const temperature = data.parameters?.temperature_2m?.value || 'N/A';
    const humidity = data.parameters?.humidity?.value || 'N/A';
    const precipitation = data.parameters?.precipitation?.value || '0';
    const solarRadiation = data.parameters?.solar_radiation?.value || 'N/A';
    const windSpeed = data.parameters?.wind_speed?.value || 'N/A';
    
    container.innerHTML = `
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
            <div class="bg-white p-4 rounded-xl border border-gray-200 text-center">
                <div class="text-xl font-bold text-blue-600 mb-1">${temperature}°C</div>
                <div class="text-sm text-gray-600">Temperature</div>
            </div>
            <div class="bg-white p-4 rounded-xl border border-gray-200 text-center">
                <div class="text-xl font-bold text-green-600 mb-1">${humidity}%</div>
                <div class="text-sm text-gray-600">Humidity</div>
            </div>
            <div class="bg-white p-4 rounded-xl border border-gray-200 text-center">
                <div class="text-xl font-bold text-purple-600 mb-1">${precipitation}mm</div>
                <div class="text-sm text-gray-600">Precipitation</div>
            </div>
            <div class="bg-white p-4 rounded-xl border border-gray-200 text-center col-span-1">
                <div class="text-lg font-bold text-orange-600 mb-1">${solarRadiation} MJ/m²</div>
                <div class="text-sm text-gray-600">Solar Radiation</div>
            </div>
            <div class="bg-white p-4 rounded-xl border border-gray-200 text-center">
                <div class="text-xl font-bold text-cyan-600 mb-1">${windSpeed} m/s</div>
                <div class="text-sm text-gray-600">Wind Speed</div>
            </div>
            <div class="bg-white p-4 rounded-xl border border-gray-200 text-center">
                <div class="text-xl font-bold text-emerald-600 mb-1">${data.quality || 'Good'}</div>
                <div class="text-sm text-gray-600">Data Quality</div>
            </div>
        </div>
        <p class="text-xs text-gray-500 mt-3 text-center">
            Data from ${data.data_source || 'NASA POWER API'} • 
            Updated: ${new Date(data.timestamp || Date.now()).toLocaleTimeString()}
        </p>
    `;
}
</script>
{% endblock %}