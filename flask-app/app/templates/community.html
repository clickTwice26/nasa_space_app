{% extends "base.html" %}
{% from "components/header_stats.html" import header_stats %}
{% from "components/community_card.html" import community_card %}
{% from "components/post_creation.html" import post_creation %}
{% from "components/filter_tabs.html" import filter_tabs %}
{% from "components/post_card.html" import post_card %}

{% block title %}TerraPulse - Community{% endblock %}
{% block subtitle %}Community Hub{% endblock %}

{% block content %}
<div class="space-y-4 pb-32">
    
    <!-- Mobile-Friendly Header -->
    <div class="app-card">
        <div class="app-card-body text-center">
            <h1 class="text-heading-1 text-gray-900 mb-2">Community Feed</h1>
            <p class="text-body text-gray-600">Connect with farmers and share knowledge</p>
        </div>
    </div>

    <!-- Mobile Stats Grid -->
    <div class="app-card">
        <div class="app-card-body">
            <div class="grid grid-cols-3 gap-4 text-center mb-4">
                <div>
                    <div class="text-heading-2 font-bold text-green-600">125K+</div>
                    <div class="text-caption text-gray-600">Active Farmers</div>
                </div>
                <div>
                    <div class="text-heading-2 font-bold text-blue-600">45</div>
                    <div class="text-caption text-gray-600">Communities</div>
                </div>
                <div>
                    <div class="text-heading-2 font-bold text-purple-600">2.3K</div>
                    <div class="text-caption text-gray-600">Daily Posts</div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <a href="/discover" class="btn-mobile btn-primary text-center touch-target">
                    <i class="fas fa-search mr-2"></i>Discover
                </a>
                <button onclick="showCreatePostModal()" class="btn-mobile bg-blue-600 text-white border-blue-600 hover:bg-blue-700 touch-target">
                    <i class="fas fa-plus mr-2"></i>Create Post
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Post Creation Card -->
    <div class="app-card">
        <div class="app-card-body">
            <div class="flex items-center gap-3 mb-3">
                <div class="w-8 h-8 bg-gradient-to-r from-green-600 to-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="text-white text-sm font-semibold">{{ user.full_name[0].upper() if user.full_name else 'U' }}</span>
                </div>
                <input type="text" 
                       placeholder="Share your farming experience..." 
                       onclick="showCreatePostModal()"
                       readonly
                       class="flex-1 bg-gray-100 rounded-full px-4 py-2 cursor-pointer hover:bg-gray-200 transition-colors touch-target">
            </div>
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button onclick="showCreatePostModal()" class="flex items-center gap-1 text-gray-600 hover:text-green-600 transition-colors touch-target">
                        <i class="fas fa-camera text-sm"></i>
                        <span class="text-caption">Photo</span>
                    </button>
                    <button onclick="showCreatePostModal()" class="flex items-center gap-1 text-gray-600 hover:text-blue-600 transition-colors touch-target">
                        <i class="fas fa-map-marker-alt text-sm"></i>
                        <span class="text-caption">Location</span>
                    </button>
                </div>
                <button onclick="showCreatePostModal()" class="btn-mobile btn-primary px-4 py-1 text-sm">
                    Post
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Filter Tabs -->
    <div class="app-card">
        <div class="app-card-body">
            <div class="flex gap-2 overflow-x-auto pb-2 -mx-2 px-2">
                <button class="px-3 py-2 bg-green-600 text-white rounded-full text-caption font-medium whitespace-nowrap touch-target" data-filter="all">
                    All Posts
                </button>
                <button class="px-3 py-2 bg-gray-100 text-gray-700 rounded-full text-caption font-medium hover:bg-gray-200 whitespace-nowrap touch-target" data-filter="questions">
                    Questions
                </button>
                <button class="px-3 py-2 bg-gray-100 text-gray-700 rounded-full text-caption font-medium hover:bg-gray-200 whitespace-nowrap touch-target" data-filter="tips">
                    Tips
                </button>
                <button class="px-3 py-2 bg-gray-100 text-gray-700 rounded-full text-caption font-medium hover:bg-gray-200 whitespace-nowrap touch-target" data-filter="market">
                    Market
                </button>
                <button class="px-3 py-2 bg-gray-100 text-gray-700 rounded-full text-caption font-medium hover:bg-gray-200 whitespace-nowrap touch-target" data-filter="alerts">
                    Alerts
                </button>
            </div>
        </div>
    </div>

    <!-- Community Feed -->
    <div class="space-y-4" id="community-feed">
        <!-- Loading State -->
        <div class="text-center py-12" id="loading-state">
            <div class="inline-flex items-center justify-center w-16 h-16 mb-4 bg-green-100 rounded-full">
                <div class="animate-spin rounded-full h-8 w-8 border-2 border-green-600 border-t-transparent"></div>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Loading Community Posts</h3>
            <p class="text-gray-600">Getting the latest updates from your community...</p>
        </div>
    </div>

    <!-- Load More -->
    <div class="text-center py-6">
        <button class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors">
            <i class="fas fa-refresh mr-2"></i>
            Load More Posts
        </button>
    </div>
</div>

<!-- Create Post Modal -->
<div id="createPostModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-4 border-b">
            <h3 class="text-lg font-semibold">Create Post</h3>
            <button onclick="hideCreatePostModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <!-- Modal Content -->
        <form id="createPostForm" enctype="multipart/form-data" class="p-4 space-y-4">
            <!-- User Info -->
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-r from-green-600 to-blue-600 rounded-full flex items-center justify-center">
                    <span class="text-white text-sm font-semibold">{{ user.full_name[0].upper() if user.full_name else 'U' }}</span>
                </div>
                <div>
                    <p class="font-medium">{{ user.full_name or user.username or 'User' }}</p>
                    <select id="postCommunity" name="community_id" class="text-sm bg-gray-100 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                        <option value="">Select community...</option>
                    </select>
                </div>
            </div>
            
            <!-- Post Content -->
            <textarea id="modalPostContent" 
                     name="content" 
                     placeholder="What's happening in your farm?" 
                     class="w-full h-32 p-3 border rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-green-500"
                     maxlength="5000"
                     required></textarea>
            
            <!-- Post Type Selection -->
            <div class="border-t pt-4">
                <label class="block text-sm font-medium mb-2">Post Type</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <label class="flex items-center space-x-2 p-2 border rounded cursor-pointer hover:bg-gray-50 post-type-option" data-type="text">
                        <input type="radio" name="post_type" value="text" checked class="text-green-600">
                        <i class="fas fa-align-left text-gray-600"></i>
                        <span class="text-sm">Text</span>
                    </label>
                    <label class="flex items-center space-x-2 p-2 border rounded cursor-pointer hover:bg-gray-50 post-type-option" data-type="image">
                        <input type="radio" name="post_type" value="image" class="text-green-600">
                        <i class="fas fa-image text-gray-600"></i>
                        <span class="text-sm">Photo</span>
                    </label>
                    <label class="flex items-center space-x-2 p-2 border rounded cursor-pointer hover:bg-gray-50 post-type-option" data-type="alert">
                        <input type="radio" name="post_type" value="alert" class="text-green-600">
                        <i class="fas fa-exclamation-triangle text-orange-500"></i>
                        <span class="text-sm">Alert</span>
                    </label>
                    <label class="flex items-center space-x-2 p-2 border rounded cursor-pointer hover:bg-gray-50 post-type-option" data-type="market">
                        <input type="radio" name="post_type" value="market" class="text-green-600">
                        <i class="fas fa-chart-line text-blue-500"></i>
                        <span class="text-sm">Market</span>
                    </label>
                </div>
            </div>
            
            <!-- Topic Selection -->
            <div>
                <label class="block text-sm font-medium mb-2">Topic</label>
                <select id="postTopic" name="topic" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="">Select a topic...</option>
                </select>
            </div>
            
            <!-- Photo Upload -->
            <div>
                <label class="block text-sm font-medium mb-2">Photo (optional)</label>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                    <input type="file" 
                           id="postImage" 
                           name="image" 
                           accept="image/*" 
                           class="hidden" 
                           onchange="handleImageUpload(event)">
                    <div id="imageUploadArea" class="text-center cursor-pointer" onclick="document.getElementById('postImage').click()">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600">Click to upload a photo</p>
                        <p class="text-xs text-gray-500 mt-1">PNG, JPG, GIF up to 5MB</p>
                    </div>
                    <div id="imagePreview" class="hidden mt-3">
                        <img id="previewImg" src="" alt="Preview" class="max-w-full h-48 object-cover rounded">
                        <button type="button" onclick="removeImage()" class="mt-2 text-red-600 text-sm hover:underline">
                            <i class="fas fa-times"></i> Remove image
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Location -->
            <div>
                <label class="block text-sm font-medium mb-2">Location (optional)</label>
                <div class="flex space-x-2">
                    <select id="postLocation" name="location" class="flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="">Select district...</option>
                    </select>
                    <button type="button" onclick="getCurrentLocation()" class="px-3 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-colors">
                        <i class="fas fa-crosshairs"></i>
                    </button>
                </div>
            </div>
            
            <!-- Tags -->
            <div>
                <label class="block text-sm font-medium mb-2">Tags (optional)</label>
                <input type="text" 
                       id="postTags" 
                       name="tags" 
                       placeholder="Add tags separated by commas..." 
                       class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                <p class="text-xs text-gray-500 mt-1">e.g., rice, irrigation, pest-control</p>
            </div>
            
            <!-- Alert-specific fields -->
            <div id="alertFields" class="hidden space-y-3">
                <div>
                    <label class="block text-sm font-medium mb-2">Alert Type</label>
                    <select name="alert_type" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="general">General Alert</option>
                        <option value="weather">Weather Alert</option>
                        <option value="pest">Pest Alert</option>
                        <option value="disease">Disease Alert</option>
                        <option value="market">Market Alert</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Severity</label>
                    <select name="alert_severity" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
            </div>
            
            <!-- Market-specific fields -->
            <div id="marketFields" class="hidden space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-2">Crop</label>
                        <input type="text" name="market_crop" placeholder="e.g., Rice, Wheat" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Price (BDT)</label>
                        <input type="number" name="market_price" placeholder="0.00" step="0.01" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-2">Unit</label>
                        <select name="market_unit" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="kg">Per kg</option>
                            <option value="maund">Per maund</option>
                            <option value="ton">Per ton</option>
                            <option value="piece">Per piece</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Market Location</label>
                        <input type="text" name="market_location" placeholder="Market name" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                </div>
            </div>
            
            <!-- Character count -->
            <div class="text-right">
                <span id="charCount" class="text-sm text-gray-500">0/5000</span>
            </div>
            
            <!-- Submit buttons -->
            <div class="flex items-center justify-end space-x-3 pt-4 border-t">
                <button type="button" onclick="hideCreatePostModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                    Cancel
                </button>
                <button type="submit" id="submitPostBtn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="submitBtnText">Post</span>
                    <i id="submitBtnLoader" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Custom Notification Modal -->
<div id="customNotificationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="customModalContent">
        <div class="p-6 text-center">
            <!-- Icon -->
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4" id="modalIcon">
                <i class="w-6 h-6" id="modalIconElement"></i>
            </div>
            
            <!-- Title -->
            <h3 class="text-lg font-medium text-gray-900 mb-2" id="modalTitle">Notification</h3>
            
            <!-- Message -->
            <p class="text-sm text-gray-500 mb-6" id="modalMessage">Message content</p>
            
            <!-- Button -->
            <button type="button" onclick="hideCustomModal()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 sm:text-sm transition-colors" id="modalButton">
                OK
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Community functionality
    const joinedCommunities = JSON.parse(localStorage.getItem('joinedCommunities') || '[]');
    const userProfile = '{{ user.profile_type if user.profile_type else "farmer" }}'; // Get from server
    
    // Initialize community page for the current cleaned layout
    function initializeCommunities() {
        // Simply initialize the community manager for the feed
        console.log('Initializing community page for profile:', userProfile);
        
        // Initialize community feed
        if (typeof communityManager !== 'undefined') {
            communityManager.loadCommunityFeed();
        }
    }

    // Join community functionality
    function joinCommunity(communityId) {
        if (!joinedCommunities.includes(communityId)) {
            joinedCommunities.push(communityId);
            localStorage.setItem('joinedCommunities', JSON.stringify(joinedCommunities));
            
            // Update button text
            const button = document.querySelector(`[data-community="${communityId}"]`);
            if (button) {
                button.textContent = 'Joined';
                button.className = button.className.replace(/bg-\w+-600/, 'bg-green-600');
                button.disabled = true;
            }
            
            updateMyCommunities();
        }
    }

    // Update my communities section - simplified for clean layout
    function updateMyCommunities() {
        // This function can be simplified since we moved discovery to separate page
        console.log('User has joined communities:', joinedCommunities);
        // The joined communities are now handled in the main feed
    }

    // Filter functionality for the clean layout
    function initializeFilters() {
        const filterButtons = document.querySelectorAll('[data-filter]');
        
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                const filter = this.dataset.filter;
                
                // Update active filter
                filterButtons.forEach(btn => {
                    btn.classList.remove('bg-green-600', 'text-white');
                    btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
                });
                
                this.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
                this.classList.add('bg-green-600', 'text-white');
                
                // Filter posts
                console.log(`Filtering posts by: ${filter}`);
                if (typeof communityManager !== 'undefined') {
                    communityManager.filterPosts(filter);
                }
            });
        });
    }

    // Event listeners
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('join-btn')) {
            const communityId = e.target.dataset.community;
            joinCommunity(communityId);
        }
    });

    // Initialize everything
    initializeCommunities();
    updateMyCommunities();
    initializeFilters();
    
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});

// Mobile responsive utilities
function initializeMobileFeatures() {
    // Touch gestures for mobile
    let startX = 0;
    let startY = 0;
    
    document.addEventListener('touchstart', function(e) {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
    });
    
    document.addEventListener('touchend', function(e) {
        const endX = e.changedTouches[0].clientX;
        const endY = e.changedTouches[0].clientY;
        
        // Simple swipe detection for future enhancements
        const diffX = startX - endX;
        const diffY = startY - endY;
        
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
            // Horizontal swipe detected
            console.log(diffX > 0 ? 'Swiped left' : 'Swiped right');
        }
    });
}

// Initialize mobile features when DOM is ready
document.addEventListener('DOMContentLoaded', initializeMobileFeatures);
</script>

<style>
/* Mobile-first responsive enhancements */
.scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
}
.scrollbar-hide::-webkit-scrollbar {
    display: none;
}

.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Enhanced mobile touch targets */
@media (max-width: 640px) {
    .community-card {
        min-height: 180px;
    }
    
    .post-card {
        margin-bottom: 1rem;
    }
    
    button, .btn {
        min-height: 44px;
        min-width: 44px;
    }
    
    /* Improved spacing for small screens */
    .space-y-4 > * + * {
        margin-top: 1rem;
    }
    
    .space-y-6 > * + * {
        margin-top: 1.5rem;
    }
}

/* Enhanced hover states for better interaction feedback */
.community-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.post-card:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

/* Modal styles */
.modal-backdrop {
    backdrop-filter: blur(4px);
}

.modal-content {
    max-height: 90vh;
    overflow-y: auto;
}

.post-type-option.selected {
    border-color: #059669;
    background-color: #f0fdf4;
}

.image-upload-area:hover {
    border-color: #059669;
    background-color: #f9fafb;
}

/* File upload styling */
.file-upload-preview {
    position: relative;
}

.file-upload-preview img {
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

/* Form field styling */
.form-group {
    margin-bottom: 1rem;
}

.form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: #374151;
}

.form-input, .form-select, .form-textarea {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: #059669;
    box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
}

/* Character counter styling */
.char-counter {
    font-size: 0.75rem;
    color: #6b7280;
}

.char-counter.warning {
    color: #f59e0b;
}

.char-counter.danger {
    color: #ef4444;
}

/* Button loading state */
.btn-loading {
    position: relative;
    color: transparent;
}

.btn-loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s linear infinite;
}

/* Location button styling */
.location-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    background-color: #eff6ff;
    color: #2563eb;
    border: 1px solid #dbeafe;
    border-radius: 0.5rem;
    transition: all 0.2s ease;
}

.location-btn:hover {
    background-color: #dbeafe;
    border-color: #93c5fd;
}

/* Grid responsive adjustments */
@media (max-width: 768px) {
    .modal-content {
        margin: 1rem;
        max-height: calc(100vh - 2rem);
    }
    
    .grid-cols-2 {
        grid-template-columns: 1fr;
    }
    
    .md\\:grid-cols-4 {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* Smooth transitions for better UX */
* {
    transition: all 0.2s ease;
}

/* Loading states */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #059669;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Fix gradient backgrounds that were not displaying properly */
.bg-gradient-nature {
    background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
    color: white;
}

.bg-gradient-nature * {
    color: white !important;
}

.bg-terra-gradient {
    background: linear-gradient(135deg, #059669 0%, #047857 50%, #065f46 100%);
    color: white;
}

.bg-blue-gradient {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%);
    color: white;
}

.bg-emerald-gradient {
    background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
    color: white;
}

.bg-indigo-gradient {
    background: linear-gradient(135deg, #6366f1 0%, #4f46e5 50%, #4338ca 100%);
    color: white;
}

.bg-purple-gradient {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 50%, #6d28d9 100%);
    color: white;
}

.bg-red-gradient {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%);
    color: white;
}

.bg-yellow-gradient {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%);
    color: white;
}

/* Ensure text is visible on gradient backgrounds */
.bg-gradient-nature *,
.bg-terra-gradient *,
.bg-blue-gradient *,
.bg-emerald-gradient *,
.bg-indigo-gradient *,
.bg-purple-gradient *,
.bg-red-gradient *,
.bg-yellow-gradient * {
    color: white !important;
}

/* Post card styling */
.post-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    border: 1px solid #f3f4f6;
    transition: all 0.2s ease;
    margin-bottom: 1rem;
}

.post-card:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transform: translateY(-1px);
}

/* Badge styling */
.badge-light {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    line-height: 1;
}

.badge-gray {
    background-color: #f3f4f6;
    color: #374151;
}

.badge-blue {
    background-color: #dbeafe;
    color: #1d4ed8;
}

.badge-green {
    background-color: #d1fae5;
    color: #047857;
}

.badge-red {
    background-color: #fee2e2;
    color: #dc2626;
}

.badge-purple {
    background-color: #ede9fe;
    color: #7c2d12;
}

.badge-yellow {
    background-color: #fef3c7;
    color: #d97706;
}

.badge-terra {
    background-color: #d1fae5;
    color: #047857;
}

/* Card light styling */
.card-light {
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    border: 1px solid #f3f4f6;
}

/* Profile picture styling */
.profile-pic {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #f3f4f6;
}

.profile-pic-fallback {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 1rem;
    color: white;
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    border: 2px solid #f3f4f6;
}

@media (max-width: 640px) {
    .profile-pic,
    .profile-pic-fallback {
        width: 40px;
        height: 40px;
        font-size: 0.875rem;
    }
}

/* Post interaction buttons */
.post-interaction {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem;
    border-radius: 0.5rem;
    transition: all 0.2s ease;
    color: #6b7280;
    font-size: 0.875rem;
    cursor: pointer;
}

.post-interaction:hover {
    color: #059669;
    background-color: #f0fdf4;
}

.post-interaction.liked {
    color: #dc2626;
}

.post-interaction.liked:hover {
    color: #b91c1c;
}
</style>

<script>
class CommunityManager {
    constructor() {
        console.log('CommunityManager constructor called');
        this.currentFilter = 'all';
        this.posts = [];
        this.communities = [];
        this.loading = false;
        this.init();
    }

    init() {
        console.log('CommunityManager init called');
        this.setupEventListeners();
        this.loadInitialData();
        this.setupProfileBasedView();
    }

    setupEventListeners() {
        // Filter tabs
        document.querySelectorAll('[data-filter]').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                const filter = tab.getAttribute('data-filter');
                this.setActiveFilter(filter);
                this.filterPosts(filter);
            });
        });

        // Community join/leave buttons
        document.addEventListener('click', (e) => {
            if (e.target.closest('[data-join-community]')) {
                e.preventDefault();
                const communityId = e.target.closest('[data-join-community]').getAttribute('data-join-community');
                this.joinCommunity(communityId);
            }
            
            if (e.target.closest('[data-leave-community]')) {
                e.preventDefault();
                const communityId = e.target.closest('[data-leave-community]').getAttribute('data-leave-community');
                this.leaveCommunity(communityId);
            }
        });

        // Post interactions
        document.addEventListener('click', (e) => {
            if (e.target.closest('[data-like-post]')) {
                e.preventDefault();
                const postId = e.target.closest('[data-like-post]').getAttribute('data-like-post');
                this.likePost(postId);
            }
            
            if (e.target.closest('[data-comment-post]')) {
                e.preventDefault();
                const postId = e.target.closest('[data-comment-post]').getAttribute('data-comment-post');
                this.toggleCommentSection(postId);
            }
        });

        // Post creation
        document.getElementById('create-post-btn')?.addEventListener('click', () => {
            this.showCreatePostModal();
        });

        // Search communities - simplified for clean layout
        const searchInput = document.querySelector('input[placeholder*="search"]');
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    this.searchCommunities(e.target.value);
                }, 300);
            });
        }
    }

    setupProfileBasedView() {
        // Simplified profile setup for clean layout
        const userProfile = '{{ user.profile_type if user.profile_type else "general" }}';
        console.log('Setting up profile-based view for:', userProfile);
        
        // No specific sections to toggle in the clean layout
        // The feed is universal and profile-based filtering happens server-side
    }

    async loadInitialData() {
        try {
            console.log('Starting to load initial data...');
            this.setLoading(true);
            
            // Load feed data
            await Promise.all([
                this.loadCommunityFeed(),
                this.loadUserCommunities(),
                this.loadSuggestedCommunities(),
                this.loadCommunityStats()
            ]);
            
            console.log('All initial data loaded successfully');
        } catch (error) {
            console.error('Error loading initial data:', error);
            this.showError('Failed to load community data');
        } finally {
            this.setLoading(false);
        }
    }

    async loadCommunityFeed(filter = 'all') {
        try {
            console.log('Loading community feed with filter:', filter);
            const response = await fetch(`/api/community/feed?type=${filter}&limit=20`);
            console.log('Feed response status:', response.status);
            const data = await response.json();
            console.log('Feed data received:', data);
            
            if (data.success) {
                this.posts = data.posts;
                this.renderFeed(data.posts);
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            console.error('Error loading feed:', error);
            this.showError('Failed to load community feed');
        }
    }

    async loadUserCommunities() {
        try {
            const response = await fetch('/api/community/my-communities');
            const data = await response.json();
            
            if (data.success) {
                this.communities = data.communities;
                this.renderUserCommunities(data.communities);
            }
        } catch (error) {
            console.error('Error loading user communities:', error);
        }
    }

    async loadSuggestedCommunities() {
        try {
            const response = await fetch('/api/community/suggested');
            const data = await response.json();
            
            if (data.success) {
                this.renderSuggestedCommunities(data.communities);
            }
        } catch (error) {
            console.error('Error loading suggested communities:', error);
        }
    }

    async loadCommunityStats() {
        try {
            const response = await fetch('/api/community/stats');
            const data = await response.json();
            
            if (data.success) {
                this.updateStats(data.stats);
            }
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    async joinCommunity(communityId) {
        try {
            const response = await fetch('/api/community/join', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ community_id: parseInt(communityId) })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.showSuccess('Successfully joined community!');
                this.updateCommunityButton(communityId, 'joined');
                await this.loadUserCommunities(); // Refresh communities
            } else {
                this.showError(data.message || 'Failed to join community');
            }
        } catch (error) {
            console.error('Error joining community:', error);
            this.showError('Failed to join community');
        }
    }

    async leaveCommunity(communityId) {
        try {
            const response = await fetch('/api/community/leave', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ community_id: parseInt(communityId) })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.showSuccess('Successfully left community');
                this.updateCommunityButton(communityId, 'left');
                await this.loadUserCommunities(); // Refresh communities
            } else {
                this.showError(data.message || 'Failed to leave community');
            }
        } catch (error) {
            console.error('Error leaving community:', error);
            this.showError('Failed to leave community');
        }
    }

    async likePost(postId) {
        try {
            const response = await fetch(`/api/community/post/${postId}/like`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.updatePostLike(postId, data.is_liked, data.likes_count);
            } else {
                this.showError(data.message || 'Failed to like post');
            }
        } catch (error) {
            console.error('Error liking post:', error);
            this.showError('Failed to like post');
        }
    }

    async searchCommunities(query) {
        if (!query.trim()) {
            this.renderSuggestedCommunities([]);
            return;
        }

        try {
            const response = await fetch(`/api/community/search?q=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            if (data.success) {
                this.renderSearchResults(data.communities);
            }
        } catch (error) {
            console.error('Error searching communities:', error);
        }
    }

    setActiveFilter(filter) {
        this.currentFilter = filter;
        
        // Update UI
        document.querySelectorAll('[data-filter]').forEach(tab => {
            tab.classList.remove('active', 'bg-terra-600', 'text-white');
            tab.classList.add('text-gray-600', 'hover:text-gray-900');
        });
        
        document.querySelector(`[data-filter="${filter}"]`)?.classList.add('active', 'bg-terra-600', 'text-white');
    }

    filterPosts(filter) {
        this.loadCommunityFeed(filter);
    }

    renderFeed(posts) {
        const feedContainer = document.getElementById('community-feed');
        if (!feedContainer) return;

        if (posts.length === 0) {
            feedContainer.innerHTML = `
                <div class="text-center py-16">
                    <div class="inline-flex items-center justify-center w-20 h-20 mb-6 bg-gray-100 rounded-full">
                        <i class="fas fa-comments text-3xl text-gray-400"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-3">No posts yet</h3>
                    <p class="text-gray-600 mb-6 max-w-md mx-auto">
                        Be the first to share something with the community! Start a conversation, ask a question, or share your farming experiences.
                    </p>
                    <button id="create-post-btn" class="inline-flex items-center px-6 py-3 bg-terra-600 text-white font-medium rounded-lg hover:bg-terra-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>
                        Create First Post
                    </button>
                </div>
            `;
            return;
        }

        feedContainer.innerHTML = posts.map(post => this.createPostHTML(post)).join('');
    }

    createPostHTML(post) {
        const timeAgo = this.formatTimeAgo(post.created_at);
        const postTypeIcon = this.getPostTypeIcon(post.post_type);
        const postTypeColor = this.getPostTypeColor(post.post_type);
        const authorName = post.author.full_name || post.author.username || 'Unknown User';
        const authorInitials = this.getAuthorInitials(authorName);
        const profilePicUrl = this.getProfilePictureUrl(post.author);
        
        return `
            <div class="post-card p-4 sm:p-6" data-post-id="${post.id}">
                <div class="flex items-start space-x-3 sm:space-x-4">
                    <!-- Profile Picture -->
                    <div class="flex-shrink-0">
                        <img src="${profilePicUrl}" 
                             alt="${authorName}" 
                             class="profile-pic"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                        <div class="profile-pic-fallback" style="display: none;">
                            <span>${authorInitials}</span>
                        </div>
                    </div>
                    
                    <!-- Post Content -->
                    <div class="flex-1 min-w-0">
                        <!-- Post Header -->
                        <div class="flex items-center justify-between flex-wrap gap-2 mb-3">
                            <div class="flex items-center space-x-2 flex-wrap">
                                <h4 class="text-sm sm:text-base font-semibold text-gray-900">
                                    ${authorName}
                                </h4>
                                <span class="badge-light badge-${postTypeColor}">
                                    <i class="${postTypeIcon} mr-1"></i>
                                    ${post.post_type.charAt(0).toUpperCase() + post.post_type.slice(1)}
                                </span>
                                ${this.getUserTypeBadge(post.author)}
                            </div>
                            <div class="flex items-center space-x-2 text-xs sm:text-sm text-gray-500">
                                <i class="fas fa-clock"></i>
                                <span>${timeAgo}</span>
                            </div>
                        </div>
                        
                        <!-- Post Title -->
                        ${post.title ? `<h5 class="text-lg font-semibold text-gray-900 mb-3">${this.escapeHtml(post.title)}</h5>` : ''}
                        
                        <!-- Post Content -->
                        <div class="mb-4">
                            <p class="text-gray-700 text-sm sm:text-base leading-relaxed">${this.escapeHtml(post.content)}</p>
                        </div>
                        
                        <!-- Post Metadata (alerts, market info, events) -->
                        ${this.createPostMetadata(post)}
                        
                        <!-- Post Actions -->
                        <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                            <div class="flex items-center space-x-1">
                                <button data-like-post="${post.id}" class="post-interaction ${post.is_liked ? 'liked' : ''}">
                                    <i class="fas fa-heart"></i>
                                    <span>${post.likes_count || 0}</span>
                                </button>
                                <button data-comment-post="${post.id}" class="post-interaction">
                                    <i class="fas fa-comment"></i>
                                    <span>${post.comments_count || 0}</span>
                                </button>
                                <button class="post-interaction">
                                    <i class="fas fa-share"></i>
                                    <span>Share</span>
                                </button>
                            </div>
                            ${post.location ? `
                                <div class="flex items-center text-xs text-gray-500">
                                    <i class="fas fa-map-marker-alt mr-1"></i>
                                    <span>${this.escapeHtml(post.location)}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    createPostMetadata(post) {
        let metadata = '';
        
        if (post.post_type === 'alert' && post.alert_type) {
            const severityColors = {
                'low': { bg: 'bg-green-50', border: 'border-green-200', text: 'text-green-800', icon: 'text-green-600' },
                'medium': { bg: 'bg-yellow-50', border: 'border-yellow-200', text: 'text-yellow-800', icon: 'text-yellow-600' },
                'high': { bg: 'bg-orange-50', border: 'border-orange-200', text: 'text-orange-800', icon: 'text-orange-600' },
                'critical': { bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-800', icon: 'text-red-600' }
            };
            
            const colors = severityColors[post.alert_severity] || severityColors['medium'];
            
            metadata += `
                <div class="mb-4 p-3 ${colors.bg} ${colors.border} border rounded-lg">
                    <div class="flex items-center space-x-2 mb-2">
                        <i class="fas fa-exclamation-triangle ${colors.icon}"></i>
                        <span class="font-semibold ${colors.text}">
                            ${post.alert_type.charAt(0).toUpperCase() + post.alert_type.slice(1)} Alert
                        </span>
                        <span class="badge-light badge-${post.alert_severity === 'critical' ? 'red' : post.alert_severity === 'high' ? 'yellow' : 'green'}">${post.alert_severity.toUpperCase()}</span>
                    </div>
                    ${post.alert_expires_at ? `
                        <p class="text-sm ${colors.text}">
                            <i class="fas fa-clock mr-1"></i>
                            Expires: ${new Date(post.alert_expires_at).toLocaleDateString()}
                        </p>
                    ` : ''}
                </div>
            `;
        }
        
        if (post.post_type === 'market' && post.market_price) {
            metadata += `
                <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-store text-blue-600"></i>
                            <span class="font-semibold text-blue-800">${post.market_crop || 'Product'}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-blue-900">à§³${post.market_price}</div>
                            <div class="text-sm text-blue-700">per ${post.market_unit || 'unit'}</div>
                        </div>
                    </div>
                    ${post.market_location ? `
                        <p class="text-sm text-blue-700 flex items-center">
                            <i class="fas fa-map-marker-alt mr-2"></i>
                            ${this.escapeHtml(post.market_location)}
                        </p>
                    ` : ''}
                </div>
            `;
        }
        
        if (post.post_type === 'event' && post.event_date) {
            const eventDate = new Date(post.event_date);
            const formattedDate = eventDate.toLocaleDateString('en-GB', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
            const formattedTime = eventDate.toLocaleTimeString('en-GB', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            metadata += `
                <div class="mb-4 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                    <div class="flex items-start space-x-3">
                        <i class="fas fa-calendar-alt text-purple-600 mt-1"></i>
                        <div class="flex-1">
                            <div class="font-semibold text-purple-800 mb-1">
                                ${post.event_type ? post.event_type.charAt(0).toUpperCase() + post.event_type.slice(1) : 'Event'}
                            </div>
                            <div class="space-y-1 text-sm text-purple-700">
                                <p class="flex items-center">
                                    <i class="fas fa-clock mr-2"></i>
                                    ${formattedDate} at ${formattedTime}
                                </p>
                                ${post.event_location ? `
                                    <p class="flex items-center">
                                        <i class="fas fa-map-marker-alt mr-2"></i>
                                        ${this.escapeHtml(post.event_location)}
                                    </p>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        return metadata;
    }

    getPostTypeIcon(type) {
        const icons = {
            'text': 'fas fa-comment',
            'image': 'fas fa-image',
            'alert': 'fas fa-exclamation-triangle',
            'market': 'fas fa-store',
            'event': 'fas fa-calendar'
        };
        return icons[type] || 'fas fa-comment';
    }

    getPostTypeColor(type) {
        const colors = {
            'text': 'gray',
            'image': 'blue',
            'alert': 'red',
            'market': 'green',
            'event': 'purple'
        };
        return colors[type] || 'gray';
    }

    formatTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);
        
        if (diffInSeconds < 60) return 'Just now';
        if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
        if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
        if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d ago`;
        
        return date.toLocaleDateString();
    }

    updateCommunityButton(communityId, action) {
        const button = document.querySelector(`[data-join-community="${communityId}"], [data-leave-community="${communityId}"]`);
        if (!button) return;

        if (action === 'joined') {
            button.textContent = 'Leave';
            button.setAttribute('data-leave-community', communityId);
            button.removeAttribute('data-join-community');
            button.className = button.className.replace('btn-terra', 'btn-outline');
        } else if (action === 'left') {
            button.textContent = 'Join';
            button.setAttribute('data-join-community', communityId);
            button.removeAttribute('data-leave-community');
            button.className = button.className.replace('btn-outline', 'btn-terra');
        }
    }

    updatePostLike(postId, isLiked, likesCount) {
        const likeButton = document.querySelector(`[data-like-post="${postId}"]`);
        if (!likeButton) return;

        const icon = likeButton.querySelector('i');
        const count = likeButton.querySelector('span');
        
        if (isLiked) {
            likeButton.classList.add('text-terra-600');
            likeButton.classList.remove('text-gray-500');
            icon.classList.add('fas');
            icon.classList.remove('far');
        } else {
            likeButton.classList.remove('text-terra-600');
            likeButton.classList.add('text-gray-500');
            icon.classList.remove('fas');
            icon.classList.add('far');
        }
        
        count.textContent = likesCount;
    }

    updateStats(stats) {
        // Update header stats if available
        const statsElements = {
            'members': document.querySelector('[data-stat="members"]'),
            'groups': document.querySelector('[data-stat="groups"]'),
            'active': document.querySelector('[data-stat="active"]')
        };

        if (statsElements.members) {
            statsElements.members.textContent = this.formatNumber(stats.total_members || 0);
        }
        if (statsElements.groups) {
            statsElements.groups.textContent = this.formatNumber(stats.total_communities || 0);
        }
    }

    formatNumber(num) {
        if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'k';
        }
        return num.toString();
    }

    getAuthorInitials(name) {
        if (!name) return 'U';
        const words = name.trim().split(' ');
        if (words.length >= 2) {
            return (words[0][0] + words[1][0]).toUpperCase();
        }
        return name.slice(0, 2).toUpperCase();
    }

    getProfilePictureUrl(author) {
        // If user has a profile picture, use it
        if (author.profile_picture) {
            return author.profile_picture;
        }
        
        // Generate a consistent avatar based on user ID
        const avatarServices = [
            'avataaars',
            'bottts',
            'identicon',
            'initials',
            'personas'
        ];
        
        const service = avatarServices[author.id % avatarServices.length];
        const seed = encodeURIComponent(author.username || author.email || author.id);
        
        return `https://api.dicebear.com/7.x/${service}/svg?seed=${seed}&backgroundColor=059669,047857,065f46&size=96`;
    }

    getUserTypeBadge(author) {
        const profileType = author.profile_type;
        if (!profileType) return '';
        
        const badges = {
            'farmer': '<span class="badge-light badge-green"><i class="fas fa-seedling mr-1"></i>Farmer</span>',
            'student': '<span class="badge-light badge-purple"><i class="fas fa-graduation-cap mr-1"></i>Student</span>',
            'researcher': '<span class="badge-light badge-blue"><i class="fas fa-microscope mr-1"></i>Researcher</span>',
            'expert': '<span class="badge-light badge-yellow"><i class="fas fa-star mr-1"></i>Expert</span>'
        };
        
        return badges[profileType] || '';
    }

    escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    setLoading(loading) {
        this.loading = loading;
        const feedContainer = document.getElementById('community-feed');
        if (feedContainer) {
            feedContainer.classList.toggle('loading', loading);
        }
    }

    showSuccess(message) {
        showCustomModalWithAutoHide(message, 'success', 'Success', 3000);
    }

    showError(message) {
        showCustomModal(message, 'error', 'Error');
    }

    showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `
            fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm w-full
            ${type === 'success' ? 'bg-green-500 text-white' : 
              type === 'error' ? 'bg-red-500 text-white' : 
              'bg-blue-500 text-white'}
        `;
        notification.innerHTML = `
            <div class="flex items-center justify-between">
                <span class="text-sm font-medium">${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        document.body.appendChild(notification);

        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    renderUserCommunities(communities) {
        // This would update the user communities section
        console.log('User communities loaded:', communities);
    }

    renderSuggestedCommunities(communities) {
        // This would update the suggested communities section
        console.log('Suggested communities loaded:', communities);
    }

    renderSearchResults(communities) {
        // This would update the search results
        console.log('Search results:', communities);
    }

    showCreatePostModal() {
        const modal = document.getElementById('createPostModal');
        if (modal) {
            modal.classList.remove('hidden');
            this.loadModalData();
        }
    }

    hideCreatePostModal() {
        try {
            const modal = document.getElementById('createPostModal');
            if (modal) {
                modal.classList.add('hidden');
                this.resetPostForm();
            }
        } catch (error) {
            console.error('Error in hideCreatePostModal:', error);
            // At minimum, hide the modal
            const modal = document.getElementById('createPostModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }
    }

    async loadModalData() {
        try {
            // Load communities, topics, and districts
            const [communitiesRes, topicsRes, districtsRes] = await Promise.all([
                fetch('/api/community/my-communities'),
                fetch('/api/community/post/topics'),
                fetch('/api/community/districts')
            ]);

            if (communitiesRes.ok) {
                const communitiesData = await communitiesRes.json();
                console.log('Communities response:', communitiesData);
                if (communitiesData.success && communitiesData.communities) {
                    this.populateCommunityDropdown(communitiesData.communities);
                } else {
                    console.warn('No communities data or unsuccessful response:', communitiesData);
                    this.populateCommunityDropdown([]);
                }
            } else {
                console.error('Failed to fetch communities:', communitiesRes.status);
                this.populateCommunityDropdown([]);
            }

            if (topicsRes.ok) {
                const topicsData = await topicsRes.json();
                if (topicsData.success && topicsData.topics) {
                    this.populateTopicsDropdown(topicsData.topics);
                } else {
                    this.populateTopicsDropdown([]);
                }
            } else {
                console.error('Failed to fetch topics:', topicsRes.status);
                this.populateTopicsDropdown([]);
            }

            if (districtsRes.ok) {
                const districtsData = await districtsRes.json();
                if (districtsData.success && districtsData.districts) {
                    this.populateDistrictsDropdown(districtsData.districts);
                } else {
                    this.populateDistrictsDropdown([]);
                }
            } else {
                console.error('Failed to fetch districts:', districtsRes.status);
                this.populateDistrictsDropdown([]);
            }
        } catch (error) {
            console.error('Error loading modal data:', error);
            // Populate with empty arrays as fallback
            this.populateCommunityDropdown([]);
            this.populateTopicsDropdown([]);
            this.populateDistrictsDropdown([]);
        }
    }

    populateCommunityDropdown(communities) {
        const select = document.getElementById('postCommunity');
        if (!select) return;

        // Clear existing options except the first one
        select.innerHTML = '<option value="">Select community...</option>';
        
        // Safety check for communities array
        if (!communities || !Array.isArray(communities)) {
            console.warn('Communities data is not a valid array:', communities);
            return;
        }
        
        communities.forEach(community => {
            const option = document.createElement('option');
            option.value = community.id;
            option.textContent = community.name;
            select.appendChild(option);
        });
    }

    populateTopicsDropdown(topics) {
        const select = document.getElementById('postTopic');
        if (!select) return;

        select.innerHTML = '<option value="">Select a topic...</option>';
        
        // Safety check for topics array
        if (!topics || !Array.isArray(topics)) {
            console.warn('Topics data is not a valid array:', topics);
            return;
        }
        
        topics.forEach(topic => {
            const option = document.createElement('option');
            option.value = topic.value;
            option.innerHTML = `<i class="${topic.icon}"></i> ${topic.label}`;
            option.textContent = topic.label;
            select.appendChild(option);
        });
    }

    populateDistrictsDropdown(districts) {
        const select = document.getElementById('postLocation');
        if (!select) return;

        select.innerHTML = '<option value="">Select district...</option>';
        
        // Safety check for districts array
        if (!districts || !Array.isArray(districts)) {
            console.warn('Districts data is not a valid array:', districts);
            return;
        }
        
        districts.forEach(district => {
            const option = document.createElement('option');
            option.value = district;
            option.textContent = district;
            select.appendChild(option);
        });
    }

    resetPostForm() {
        try {
            const form = document.getElementById('createPostForm');
            if (form) {
                form.reset();
                
                // Reset specific elements safely
                if (typeof removeImage === 'function') {
                    removeImage(); // Call global function, not class method
                }
                
                if (typeof this.hideConditionalFields === 'function') {
                    this.hideConditionalFields();
                }
                
                if (typeof this.updateCharCount === 'function') {
                    this.updateCharCount();
                }
                
                // Reset post type to text
                const textRadio = form.querySelector('input[name="post_type"][value="text"]');
                if (textRadio) {
                    textRadio.checked = true;
                }
            }
        } catch (error) {
            console.error('Error in resetPostForm:', error);
            // Even if reset fails, try to reset the form manually
            const form = document.getElementById('createPostForm');
            if (form) {
                form.reset();
            }
        }
    }

    hideConditionalFields() {
        const alertFields = document.getElementById('alertFields');
        const marketFields = document.getElementById('marketFields');
        const titleField = document.getElementById('titleField');
        
        if (alertFields) alertFields.classList.add('hidden');
        if (marketFields) marketFields.classList.add('hidden');
        if (titleField) titleField.classList.add('hidden');
    }

    updateCharCount() {
        const textarea = document.getElementById('postContent');
        const charCount = document.getElementById('charCount');
        
        if (textarea && charCount) {
            const count = textarea.value.length;
            charCount.textContent = `${count}/5000`;
            charCount.className = count > 4500 ? 'text-sm text-red-500' : 'text-sm text-gray-500';
        }
    }

    toggleCommentSection(postId) {
        // This would toggle the comment section for a post
        console.log('Toggle comments for post:', postId);
    }
}

// Global functions for the modal
function showCreatePostModal() {
    if (window.communityManager) {
        window.communityManager.showCreatePostModal();
    }
}

function hideCreatePostModal() {
    if (window.communityManager) {
        window.communityManager.hideCreatePostModal();
    }
}

function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Validate file size (5MB)
    if (file.size > 5 * 1024 * 1024) {
        alert('File size too large. Maximum 5MB allowed.');
        event.target.value = '';
        return;
    }

    // Validate file type
    const allowedTypes = ['image/png', 'image/jpg', 'image/jpeg', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        alert('Invalid file type. Please select a PNG, JPG, GIF, or WebP image.');
        event.target.value = '';
        return;
    }

    // Create preview
    const reader = new FileReader();
    reader.onload = function(e) {
        const uploadArea = document.getElementById('imageUploadArea');
        const preview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        
        if (uploadArea && preview && previewImg) {
            uploadArea.classList.add('hidden');
            preview.classList.remove('hidden');
            previewImg.src = e.target.result;
        }
    };
    reader.readAsDataURL(file);
}

function removeImage() {
    const uploadArea = document.getElementById('imageUploadArea');
    const preview = document.getElementById('imagePreview');
    const fileInput = document.getElementById('postImage');
    const previewImg = document.getElementById('previewImg');
    
    if (uploadArea) uploadArea.classList.remove('hidden');
    if (preview) preview.classList.add('hidden');
    if (fileInput) fileInput.value = '';
    if (previewImg) previewImg.src = '';
}

function getCurrentLocation() {
    if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                // For now, just show success message
                // In a real app, you'd reverse geocode to get district
                alert('Location detected! Please select your district from the dropdown.');
            },
            function(error) {
                alert('Unable to get your location. Please select your district manually.');
            }
        );
    } else {
        alert('Geolocation is not supported by this browser. Please select your district manually.');
    }
}

// Initialize modal functionality when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    // Handle post type changes
    document.addEventListener('change', function(e) {
        if (e.target.name === 'post_type') {
            const postType = e.target.value;
            const alertFields = document.getElementById('alertFields');
            const marketFields = document.getElementById('marketFields');
            const titleField = document.getElementById('titleField');
            
            // Hide all conditional fields first
            if (alertFields) alertFields.classList.add('hidden');
            if (marketFields) marketFields.classList.add('hidden');
            if (titleField) titleField.classList.add('hidden');
            
            // Show relevant fields
            if (postType === 'alert' && alertFields) {
                alertFields.classList.remove('hidden');
                titleField.classList.remove('hidden');
            } else if (postType === 'market' && marketFields) {
                marketFields.classList.remove('hidden');
                titleField.classList.remove('hidden');
            } else if ((postType === 'image' || postType === 'event') && titleField) {
                titleField.classList.remove('hidden');
            }
        }
    });

    // Handle character count
    const contentTextarea = document.getElementById('modalPostContent');
    if (contentTextarea) {
        contentTextarea.addEventListener('input', function() {
            const charCount = document.getElementById('charCount');
            if (charCount) {
                const count = this.value.length;
                charCount.textContent = `${count}/5000`;
                charCount.className = count > 4500 ? 'text-sm text-red-500' : 'text-sm text-gray-500';
            }
        });
    }

    // Handle form submission
    const createPostForm = document.getElementById('createPostForm');
    if (createPostForm) {
        createPostForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitPostBtn');
            const submitBtnText = document.getElementById('submitBtnText');
            const submitBtnLoader = document.getElementById('submitBtnLoader');
            
            // Show loading state
            if (submitBtn) submitBtn.disabled = true;
            if (submitBtnText) submitBtnText.textContent = 'Posting...';
            if (submitBtnLoader) submitBtnLoader.classList.remove('hidden');
            
            try {
                const formData = new FormData(this);
                
                const response = await fetch('/api/community/post/create', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                console.log('Post creation response:', result);
                
                if (response.ok && result.success) {
                    try {
                        hideCreatePostModal();
                        if (window.communityManager) {
                            window.communityManager.showSuccess('Post created successfully!');
                            window.communityManager.loadFeed();
                        } else {
                            showCustomModalWithAutoHide('Post created successfully!', 'success', 'Success', 3000);
                            setTimeout(() => window.location.reload(), 2000);
                        }
                    } catch (modalError) {
                        console.error('Error in success handling:', modalError);
                        // Even if modal close fails, the post was created successfully
                        showCustomModalWithAutoHide('Post created successfully!', 'success', 'Success', 3000);
                        setTimeout(() => window.location.reload(), 2000);
                    }
                } else {
                    const errorMessage = result.message || `Failed to create post (Status: ${response.status})`;
                    console.error('Post creation failed:', errorMessage, result);
                    showCustomModal(errorMessage, 'error');
                }
            } catch (error) {
                console.error('Error creating post:', error);
                showCustomModal('Failed to create post. Please try again.', 'error');
            } finally {
                // Reset loading state
                if (submitBtn) submitBtn.disabled = false;
                if (submitBtnText) submitBtnText.textContent = 'Post';
                if (submitBtnLoader) submitBtnLoader.classList.add('hidden');
            }
        });
    }

    // Close modal when clicking outside
    const modal = document.getElementById('createPostModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                hideCreatePostModal();
            }
        });
    }
});

// Initialize the community manager when the page loads
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM content loaded, initializing CommunityManager...');
    window.communityManager = new CommunityManager();
    
    // Test direct API call
    setTimeout(() => {
        console.log('Testing direct feed API call...');
        fetch('/api/community/feed?type=all&limit=20')
            .then(response => {
                console.log('Direct API call response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Direct API call data:', data);
            })
            .catch(error => {
                console.error('Direct API call error:', error);
            });
    }, 2000);
});

// Custom Modal Functions
function showCustomModal(message, type = 'info', title = null) {
    const modal = document.getElementById('customNotificationModal');
    const content = document.getElementById('customModalContent');
    const icon = document.getElementById('modalIcon');
    const iconElement = document.getElementById('modalIconElement');
    const titleElement = document.getElementById('modalTitle');
    const messageElement = document.getElementById('modalMessage');
    const button = document.getElementById('modalButton');
    
    if (!modal || !content) return;
    
    // Set content
    messageElement.textContent = message;
    titleElement.textContent = title || (type === 'success' ? 'Success' : type === 'error' ? 'Error' : 'Notification');
    
    // Set styling based on type
    if (type === 'success') {
        icon.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4 bg-green-100';
        iconElement.className = 'w-6 h-6 text-green-600 fas fa-check';
        button.className = 'w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:text-sm transition-colors';
    } else if (type === 'error') {
        icon.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4 bg-red-100';
        iconElement.className = 'w-6 h-6 text-red-600 fas fa-times';
        button.className = 'w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:text-sm transition-colors';
    } else {
        icon.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4 bg-blue-100';
        iconElement.className = 'w-6 h-6 text-blue-600 fas fa-info';
        button.className = 'w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm transition-colors';
    }
    
    // Show modal with animation
    modal.classList.remove('hidden');
    
    // Trigger animation
    setTimeout(() => {
        content.classList.remove('scale-95', 'opacity-0');
        content.classList.add('scale-100', 'opacity-100');
    }, 10);
}

function hideCustomModal() {
    const modal = document.getElementById('customNotificationModal');
    const content = document.getElementById('customModalContent');
    
    if (!modal || !content) return;
    
    // Animate out
    content.classList.remove('scale-100', 'opacity-100');
    content.classList.add('scale-95', 'opacity-0');
    
    // Hide modal after animation
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 300);
}

// Auto-hide success modals after 3 seconds
function showCustomModalWithAutoHide(message, type = 'info', title = null, autoHideTime = 3000) {
    showCustomModal(message, type, title);
    
    if (type === 'success' && autoHideTime > 0) {
        setTimeout(() => {
            hideCustomModal();
        }, autoHideTime);
    }
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    const modal = document.getElementById('customNotificationModal');
    if (e.target === modal) {
        hideCustomModal();
    }
});
</script>
{% endblock %}